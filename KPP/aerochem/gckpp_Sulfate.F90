!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !MODULE: gckpp_Sulfate
!
! !DESCRIPTION: FlexChem module for multiphase sulfate chemistry, via KPP.
!\\
!\\
! !INTERFACE:

MODULE GCKPP_SULFATE
!
! !USES:
!
  USE PhysConstants    ! Physical constants
  USE PRECISION_MOD    ! For GEOS-Chem Precision (fp, f4, f8)
  USE GCKPP_Global,    ONLY : K_MT, K_CLD, K_DST, NUMDEN, C
  USE GCKPP_Parameters
  USE Error_Mod,       ONLY : SAFE_DIV
  USE gckpp_HetRates

  IMPLICIT NONE
  PRIVATE
!
! !PUBLIC MEMBER FUNCTIONS:
!
  PUBLIC :: SET_CLD_S
  PUBLIC :: INIT_SULFATE

  ! Species ID flags
  INTEGER                :: id_AS,     id_AHS,    id_AW1
  INTEGER                :: id_DAL1,   id_DAL2,   id_DAL3
  INTEGER                :: id_DAL4,   id_DMS,    id_DST1
  INTEGER                :: id_DST2,   id_DST3,   id_DST4
  INTEGER                :: id_H2O2,   id_HNO3,   id_LET
  INTEGER                :: id_MSA,    id_NH3,    id_NH4
  INTEGER                :: id_NH4aq,  id_NIT,    id_NITd1
  INTEGER                :: id_NITd2,  id_NITd3,  id_NITd4
  INTEGER                :: id_NITs,   id_NK1,    id_NK5
  INTEGER                :: id_NK8,    id_NK10,   id_NK20
  INTEGER                :: id_NO3,    id_O3,     id_OH
  INTEGER                :: id_SALA,   id_SALC,   id_SF1
  INTEGER                :: id_SO2,    id_SO4,    id_SO4aq
  INTEGER                :: id_SO4d1,  id_SO4d2,  id_SO4d3
  INTEGER                :: id_SO4d4,  id_SO4s,   id_pFe
  INTEGER                :: id_SALACL, id_HCL,    id_SALCCL
  INTEGER                :: id_SALAAL, id_SALCAL
  INTEGER                :: id_HOBr,   id_SO4H1,  id_SO4H2
  INTEGER                :: id_HOCl,   id_SO4H3,  id_SO4H4
  INTEGER                :: id_HCOOH,  id_ACTA            !jmm 1/31/19
  INTEGER                :: id_CH2O,   id_HMS             ! msl

  REAL(fp),  PARAMETER   :: TCVV_S      = AIRMW / 32e+0_fp ! hard-coded MW
  REAL(fp),  PARAMETER   :: TCVV_N      = AIRMW / 14e+0_fp ! hard-coded MW
  REAL(fp),  PARAMETER   :: SMALLNUM    = 1e-20_fp
  REAL(fp),  PARAMETER   :: CM3PERM3    = 1.e6_fp

CONTAINS
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: set_sulfate
!
! !DESCRIPTION: Subroutine SET_CLD_S is the interface between KPP 
! and the sulfate chemistry rates.
!
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE SET_CLD_S( I, J, L, Input_Opt,  State_Chm, State_Diag, State_Grid, &
                          State_Met,  RC )
!
! !USES:
!
    USE ErrCode_Mod
    USE ERROR_MOD
    USE Input_Opt_Mod,      ONLY : OptInput
    USE State_Chm_Mod,      ONLY : ChmState
    USE State_Chm_Mod,      ONLY : Ind_
    USE State_Diag_Mod,     ONLY : DgnState
    USE State_Grid_Mod,     ONLY : GrdState
    USE State_Met_Mod,      ONLY : MetState
    USE TIME_MOD,           ONLY : GET_MONTH
    USE TIME_MOD,           ONLY : GET_TS_CHEM
!
! !INPUT PARAMETERS:
!
    TYPE(OptInput), INTENT(IN)    :: Input_Opt   ! Input Options object
    TYPE(GrdState), INTENT(IN)    :: State_Grid  ! Grid State object
    TYPE(MetState), INTENT(IN)    :: State_Met   ! Meteorology State object
    INTEGER,        INTENT(IN)    :: I, J, L
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(ChmState), INTENT(INOUT) :: State_Chm   ! Chemistry State object
    TYPE(DgnState), INTENT(INOUT) :: State_Diag  ! Diagnostics State object
!
! !OUTPUT PARAMETERS:
!
    INTEGER,        INTENT(OUT)   :: RC          ! Success or failure?
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    LOGICAL                  :: prtDebug
    INTEGER                  :: N
    CHARACTER(LEN=63)        :: OrigUnit

    ! Strings
    CHARACTER(LEN=255)       :: ErrMsg, ThisLoc

    ! Pointers
    ! Coming in from FlexChem_Mod, Spc is in mcl/cm3 (MND)
    REAL(fp), POINTER        :: Spc(:,:,:,:)

    !=================================================================
    ! SET_CLD_S begins here!
    !=================================================================

    ! Initialize
    RC       = GC_SUCCESS
    ErrMsg   = ''
    ThisLoc  = ' -> at SET_CLD_S (in module GeosCore/sulfate_mod.F90)'

    ! Initialize pointers
!    Spc                  => State_Chm%Species  ! Chemistry species [mcl/cm3]

    ! Should we print debug output?
    prtDebug             = ( Input_Opt%LPRT .and. Input_Opt%amIRoot )

    !=================================================================
    ! Call individual chemistry routines for sulfate/aerosol tracers
    !=================================================================

    !-----------------------
    ! SO2 chemistry
    !-----------------------
    CALL SET_SO2( I, J, L, Input_Opt, State_Chm, State_Diag, State_Grid, &
         State_Met, RC )
    
    ! Trap potential errors
    IF ( RC /= GC_SUCCESS ) THEN
       ErrMsg = 'Error encountered in "Chem_SO2"!'
       CALL GC_Error( ErrMsg, RC, ThisLoc )
       RETURN
    ENDIF
    
    ! Debug info
    IF ( prtDebug ) THEN
       CALL DEBUG_MSG( '### SET_CLD_S: a CHEM_SO2' )
    ENDIF
    
    !-----------------------
    ! SO4 chemistry
    !-----------------------
!    CALL CHEM_SO4( Input_Opt,  State_Chm, State_Diag, State_Grid, &
!         State_Met, RC )
    
    ! Trap potential errors
    IF ( RC /= GC_SUCCESS ) THEN
       ErrMsg = 'Error encountered in "Chem_SO4"!'
       CALL GC_Error( ErrMsg, RC, ThisLoc )
       RETURN
    ENDIF
    
    IF ( prtDebug ) THEN
       CALL DEBUG_MSG( '### SET_CLD_S: a CHEM_SO4' )
    ENDIF
    
    ! MSA
!    CALL CHEM_MSA( Input_Opt, State_Chm, State_Grid, State_Met, RC )
    IF ( prtDebug ) THEN
       CALL DEBUG_MSG( '### SET_CLD_S: a CHEM_MSA' )
    ENDIF
    
    ! Sulfur Nitrate.
    ! CHEM_NIT includes a source term from sea salt aerosols, so keep
    ! here.
!    CALL CHEM_NIT( Input_Opt, State_Chm, State_Grid, State_Met, RC )
    IF ( prtDebug ) THEN
       CALL DEBUG_MSG( '### SET_CLD_S: a CHEM_NIT' )
    ENDIF
    
    ! Calculate the HCl uptake by alkalinity, xnw
!    CALL CHEM_CL( Input_Opt, State_Met, State_Chm, State_Grid, RC )
    IF ( prtDebug ) THEN
       CALL DEBUG_MSG( '### SET_CLD_S: a CHEM_CL' )
    ENDIF
    
    ! Free pointer
    Spc => NULL()

  END SUBROUTINE SET_CLD_S
!EOC
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: chem_so2
!
! !DESCRIPTION: Subroutine CHEM\_SO2 is the SO2 chemistry subroutine.
!  (rjp, bmy, 11/26/02, 8/26/10)
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE SET_SO2( I, J, L, Input_Opt, State_Chm,  State_Diag, State_Grid, &
                       State_Met, RC )
!
! !USES:
!
    USE CMN_SIZE_Mod,         ONLY : NDSTBIN
    USE ErrCode_Mod
    USE ERROR_MOD,            ONLY : IS_SAFE_EXP
    USE ERROR_MOD,            ONLY : SAFE_DIV
    USE Input_Opt_Mod,        ONLY : OptInput
    USE State_Chm_Mod,        ONLY : ChmState
    USE State_Diag_Mod,       ONLY : DgnState
    USE State_Grid_Mod,       ONLY : GrdState
    USE State_Met_Mod,        ONLY : MetState
    USE TIME_MOD,             ONLY : GET_TS_CHEM, GET_MONTH
    USE TIME_MOD,             ONLY : ITS_A_NEW_MONTH
#ifdef APM
    USE APM_DRIV_MOD,         ONLY : PSO4GAS
    USE APM_DRIV_MOD,         ONLY : XO3
#endif
!
! !INPUT PARAMETERS:
!
    TYPE(OptInput), INTENT(IN)    :: Input_Opt   ! Input Options object
    TYPE(GrdState), INTENT(IN)    :: State_Grid  ! Grid State object
    TYPE(MetState), INTENT(IN)    :: State_Met   ! Meteorology State object
    INTEGER,        INTENT(IN)    :: I, J, L
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(ChmState), INTENT(INOUT) :: State_Chm   ! Chemistry State object
    TYPE(DgnState), INTENT(INOUT) :: State_Diag  ! Diagnostics State object
!
! !OUTPUT PARAMETERS:
!
    INTEGER,        INTENT(INOUT) :: RC          ! Success or failure?
!
! !REMARKS:
!  Reaction List (by Rokjin Park)
!  ============================================================================
!  (1 ) SO2 production:
!       DMS + OH, DMS + NO3 (saved in CHEM_DMS)
!                                                                             .
!  (2 ) SO2 loss:
!       (a) SO2 + OH  -> SO4
!       (b) SO2       -> drydep
!       (c) SO2 + H2O2 or O3 (aq) -> SO4
!                                                                             .
!  (3 ) SO2 = SO2_0 * exp(-bt) +  PSO2_DMS/bt * [1-exp(-bt)]
!                                                                             .
!       where b is the sum of the reaction rate of SO2 + OH and the dry
!       deposition rate of SO2, PSO2_DMS is SO2 production from DMS in
!       MixingRatio/timestep.
!                                                                             .
!  If there is cloud in the gridbox (fraction = fc), then the aqueous
!  phase chemistry also takes place in cloud. The amount of SO2 oxidized
!  by H2O2 in cloud is limited by the available H2O2; the rest may be
!  oxidized due to additional chemistry, e.g, reaction with O3 or O2
!  (catalyzed by trace metal).
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    REAL(fp),  PARAMETER  :: HPLUS_45  = 3.16227766016837953e-5_fp  !pH = 4.5
    REAL(fp),  PARAMETER  :: HPLUS_50  = 1.0e-5_fp  !pH = 5.0
    REAL(fp),  PARAMETER  :: MINDAT    = 1.e-20_fp
!
! !LOCAL VARIABLES:
!
    ! Scalars
    LOGICAL               :: IS_OFFLINE
    LOGICAL               :: IS_FULLCHEM
    INTEGER               :: BULK,   SIZE_RES
    INTEGER               :: IBIN
    REAL(fp)              :: K0,     Ki,      KK,     M,    L1
    REAL(fp)              :: L2,     L3,      Ld,     F,    Fc
    REAL(fp)              :: RK,     RKT,     DTCHEM, DT_T, TK
    REAL(fp)              :: F1,     RK1,    RK3,  SO20
    REAL(fp)              :: SO2_cd, H2O20,   O3,     L2S,  L3S
    REAL(fp)              :: LWC,    KaqH2O2, KaqO3,  PATM, RHO, CVFAC
    REAL(fp)              :: ALK,    ALK1,    ALK2,    SO2_AfterSS
    REAL(fp)              :: AlkA,   AlkC
    REAL(fp)              :: Kt1,    Kt2
    REAL(fp)              :: PSO4E,  PSO4F,   Kt1N,    Kt2N
    REAL(fp)              :: XX, Kt1L, Kt2L
    REAL(fp)              :: HPLUS,  SO4nss, TNH3,   TNO3,  GNO3, ANIT
    REAL(fp)              :: LSTOT,  ALKdst, ALKss,  ALKds, NH3, CL, TNA
    REAL(fp)              :: SSCvv,  aSO4,   SO2_sr, SR,    TANIT
    REAL(fp)              :: TFA,  TAA,   TDCA    ! (jmm, 12/03/2018)
    REAL(fp)              :: PSO4d_tot, PNITd_tot
    REAL(fp)              :: SO2_gas,   PH2SO4d_tot
    REAL(fp)              :: H2SO4_cd,  H2SO4_gas

    ! (qjc, 04/10/16)
    REAL(fp)              :: L5,L5S,SRo3,SRhobr
    REAL(fp)              :: L5_1,L5S_1,L3_1,L3S_1,KaqO3_1
    REAL(fp)              :: HSO3aq, SO3aq
    REAL(fp)              :: SO2_AfterSS0, rSIV, fupdateHOBr_0
    REAL(fp)              :: HCO3, HCHOBr, KO3, KHOBr, f_srhobr, HOBr0
    REAL(fp)              :: TMP

    REAL(fp)              :: KaqO2, L4, L4S, MnII, FeIII
    REAL(fp)              :: DUST,  Mn_ant,  Mn_nat
    REAL(fp)              :: Mn_tot, Mn_d,    Fe_d
    REAL(fp)              :: Fe_ant, Fe_nat,  Fe_tot
    REAL(fp)              :: Fe_d_ant, Fe_d_nat

    REAL(fp)              :: L6,L6S,SRhocl,L6_1,L6S_1      !XW
    REAL(fp)              :: fupdateHOCl_0  !XW
    REAL(fp)              :: HCHOCl, KHOCl, f_srhocl, HOCl0 !XW

    REAL(fp)              :: KaqHCHO, KaqHMS, KaqHMS2, HMSc ! JMM, MSL

    ! Arrays
    ! tdf 04/07/08
    REAL(fp)              :: ALK_d   (NDSTBIN)
    REAL(fp)              :: ALKA_d  (NDSTBIN)
    REAL(fp)              :: PSO4_d  (NDSTBIN)
    REAL(fp)              :: PNIT_d  (NDSTBIN)
    REAL(fp)              :: PH2SO4_d(NDSTBIN)
    REAL(fp)              :: KTN(NDSTBIN)
    REAL(fp)              :: KTS(NDSTBIN)
    REAL(fp)              :: KTH(NDSTBIN)
    !tdf KTH now contains the fraction of uptake of H2SO4 on to each of the
    ! dust size bins, based on a size- and area-weighted formulism
    ! (GET_DUST_ALK)
    REAL(fp)              :: O3m(State_Grid%NX,State_Grid%NY,State_Grid%NZ)

    ! Pointers
    REAL(fp), POINTER     :: Spc(:)
    REAL(fp), POINTER     :: SSAlk(:)

    ! For HEMCO update
    LOGICAL, SAVE         :: FIRST = .TRUE.

    CHARACTER(LEN=255)    :: ErrMsg, ThisLoc

    ! For H2OS4 production, used in dust acid uptake
    

#ifdef LUO_WETDEP
    ! For Luo et al wetdep scheme
    LOGICAL               :: Is_QQ3D
#endif

    ! Cloud parameters
    REAL(fp)               :: rLiq, ALiq, VLiq, CLDFr
    REAL(fp)               :: rIce, AIce, VIce


    !=================================================================
    ! SET_SO2 begins here!
    !=================================================================
    IF ( id_H2O2 < 0 .or. id_SO2 < 0  ) RETURN

    ! Assume success
    RC      = GC_SUCCESS
    ErrMsg  = ''
    ThisLoc = ' -> at SET_SO2 (in module GeosCore/sulfate_mod.F90)'

    Spc                         => State_Chm%Species(I,J,L,:)
    SSAlk                       => State_Chm%SSAlk(I,J,L,:)
    State_Chm%isCloud(I,J,L)    =  0.0_fp
    State_Chm%pHCloud(I,J,L)    =  0.0_fp
    State_Chm%QLxpHCloud(I,J,L) =  0.0_fp
    DTCHEM                      =  GET_TS_CHEM()  ! Timestep [s]

    ! Factor to convert AIRDEN from [kg air/m3] to [molec air/cm3]
    F        = 1000.e+0_fp / AIRMW * AVO * 1.e-6_fp

    ! On first call, get pointers to HEMCO diagnostics arrays.
    ! These are the sea salt aerosol number densities for the fine
    ! and coarse mode, respectively. Values are in # / surface grid
    ! box. These values are needed in the GET_ALK call below.
    ! If the diagnostics are not being found, e.g. because the
    ! sea salt emissions extension is turned off, the passed
    ! pointers NDENS_SALA and NDENS_SALC will stay nullified.
    ! Values of zero will be used in this case! (ckeller, 01/12/2015)

    ! Initialize for safety's sake
    Ld       = 0.0_fp
    LSTOT    = 0.0_fp
       
    RHO    = State_Met%AIRDEN(I,J,L)
    CVFAC  = 1.E3_fp * AIRMW / ( RHO * AVO ) ! mcl/cm3 -> v/v, or v/v -> cm3/mcl

    ! Initial SO2, H2O2, HOBr, and O3 [v/v]
    SO20   = Spc(id_SO2)*CVFAC
    H2O20  = Spc(id_H2O2)*CVFAC

    ! Calculate O3, defined only in the chemistry grid
    ! Get O3 from State_Chm%Species [v/v]
    IF ( State_Met%InChemGrid(I,J,L) ) THEN
       O3 = State_Chm%Species(I,J,L,id_O3)
    ELSE
       O3 = 0e+0_fp
    ENDIF

    ! PATM  : Atmospheric pressure in atm
    ! Now use dry air partial pressure (ewl, 4/28/15)
    PATM = State_Met%PMID_DRY( I, J, L ) / ( ATM * 1.e-2_fp )
    
    ! TK : Temperature [K]
    TK = State_Met%T(I,J,L)

    ! Updated to match JPL 2006 + full chem (jaf, 10/14/09)
    K0 = 3.3e-31_fp * ( 300.e+0_fp / TK )**4.3e+0_fp
    Ki = 1.6e-12_fp

    !==============================================================
    ! %%% NOTE: THIS IS ONLY DONE FOR ACID UPTAKE SIMULATIONS %%%
    !==============================================================
    ! Get dust alkalinity ALK_d (NDSTBIN) [v/v], Uptake rates for
    ! sulfate, KTS(NDSTBIN), and nitrate, KTN(NDSTBIN) on dust [s-1]
    CALL GET_DUST_ALK( I, J, L, ALK_d, KTS, KTN, KTH, &
                       Input_Opt, State_Met, State_Chm )

    K_DST(1)  = KIIR1Ltd( C(ind_SO2), 2.e0*C(ind_DSTAL1), KTS(1) )
    K_DST(2)  = KIIR1Ltd( C(ind_SO2), 2.e0*C(ind_DSTAL2), KTS(2) )
    K_DST(3)  = KIIR1Ltd( C(ind_SO2), 2.e0*C(ind_DSTAL3), KTS(3) )
    K_DST(4)  = KIIR1Ltd( C(ind_SO2), 2.e0*C(ind_DSTAL4), KTS(4) ) 

    K_DST(5)  = KIIR1Ltd( C(ind_HNO3), C(ind_DSTAL1), KTN(1) )
    K_DST(6)  = KIIR1Ltd( C(ind_HNO3), C(ind_DSTAL2), KTN(2) )
    K_DST(7)  = KIIR1Ltd( C(ind_HNO3), C(ind_DSTAL3), KTN(3) )
    K_DST(8)  = KIIR1Ltd( C(ind_HNO3), C(ind_DSTAL4), KTN(4) )

    K_DST(9)  = KIIR1Ltd( C(ind_H2SO4), 2.e0*C(ind_DSTAL1), KTH(1) )
    K_DST(10) = KIIR1Ltd( C(ind_H2SO4), 2.e0*C(ind_DSTAL2), KTH(2) )
    K_DST(11) = KIIR1Ltd( C(ind_H2SO4), 2.e0*C(ind_DSTAL3), KTH(3) )
    K_DST(12) = KIIR1Ltd( C(ind_H2SO4), 2.e0*C(ind_DSTAL4), KTH(4) )

    ! Gas phase SO4 production is done here in offline run only
    F   = 1000.e+0_fp / AIRMW * AVO * 1.e-6_fp
    M   = State_Met%AIRDEN(I,J,L) * F
    KK  = K0 * M / Ki
    F1  = ( 1.e+0_fp + ( LOG10( KK ) )**2 )**( -1 )
    K_DST(13) = ( K0 * M / ( 1.e+0_fp + KK ) ) * 0.6e+0_fp**F1

    ! Get cloud fraction from met fields
    FC      = State_Met%CLDF(I,J,L)

    ! Get liquid water content [m3 H2O/m3 air] within cloud from met flds
    ! Units: [kg H2O/kg air] * [kg air/m3 air] * [m3 H2O/1e3 kg H2O]
#ifdef LUO_WETDEP
    ! Luo et al wetdep scheme
    IF ( Is_QQ3D ) THEN
       LWC = State_Met%QL(I,J,L) * State_Met%AIRDEN(I,J,L) * 1e-3_fp + &
            MAX( 0.0_fp, State_Chm%QQ3D(I,J,L) * DTCHEM )
    ELSE
       LWC = State_Met%QL(I,J,L) * State_Met%AIRDEN(I,J,L) * 1e-3_fp
    ENDIF
#else
    ! Default scheme
    LWC = State_Met%QL(I,J,L) * State_Met%AIRDEN(I,J,L) * 1e-3_fp
#endif

    LWC  = MAX( 0.0e+0_fp, LWC )

    ! LWC is a grid-box averaged quantity. To improve the representation
    ! of sulfate chemistry, we divide LWC by the cloud fraction and
    ! compute sulfate chemistry based on the LWC within the cloud.  We
    ! get the appropriate grid-box averaged mass of SO2 and sulfate by
    ! multiplying these quantities by FC AFTER computing the aqueous
    ! sulfur chemistry within the cloud. (lzh, jaf, bmy, 5/27/11)
    LWC     = SAFE_DIV( LWC, FC, 0e+0_fp )

    ! Zero variables
    KaqH2O2 = 0.e+0_fp
    KaqO3   = 0.e+0_fp
    KaqO3_1 = 0.e+0_fp !(qjc, 04/10/16)
    KaqO2   = 0.e+0_fp

    SO2_AfterSS = Spc(id_SO2) * CVFAC

    K_CLD    = 0.d0

    ! If (1) there is cloud, (2) there is SO2 present, and
    ! (3) the T > -15 C, then compute aqueous SO2 chemistry
    ! Prevent divide-by-zero if LWC=0 (mpayer, 9/6/13)
    IF ( ( FC     > 1.e-4_fp   )  .AND. &
         ( SO2_AfterSS > MINDAT )  .AND. &
         ( TK     > 258.0  )  .AND. &
         ( LWC    > 0.e+0_fp   ) ) THEN
       !===========================================================
       ! NOTE...Sulfate production from aquatic reactions of SO2
       ! with H2O2 & O3 is computed here and followings are
       ! approximations or method used for analytical (integral)
       ! solution of these computations.
       !
       ! 1) with H2O2(aq)
       !      [HSO3-] + [H+] + [H2O2(aq)] => [SO4=]     (rxn)
       !      d[SO4=]/dt = k[H+][HSO3-][H2O2(aq)] (M/s) (rate)
       !
       ! we can rewrite k[H+][HSO3-] as K1 pSO2 hSO2,
       ! where pSO2 is equilibrium vapor pressure of SO2(g)
       ! in atm, and hSO2 is henry's law constant for SO2
       !
       ! Therefore, rate can be written as
       !
       !       k * K1 * pSO2 * hSO2 * pH2O2 * hH2O2,
       !
       ! where pH2O2 is equilibrium vapor pressure of H2O2(g),
       ! and hH2O2 is henry's law constant for H2O2. Detailed
       ! values are given in AQSET_SO2 routine.
       !
       ! Let us define a fraction of gas phase of A species
       ! in equilibrium with aqueous phase as
       !
       !        xA  = 1/(1+f),
       !
       ! where  f   = hA * R * T * LWC,
       !        hA  = Henry's constant,
       !        R   = gas constant,
       !        T   = temperature in kelvin,
       !        LWC = liquid water content [m3/m3]
       !
       ! As a result, the rate would become:
       !
       !    d[SO4=]
       !    ------- = k K1 hSO2 hH2O2 xSO2 xH2O2 P P [SO2][H2O2]
       !      dt
       !      ^       ^                            ^   ^    ^
       !      |       |____________________________|   |    |
       !
       !   mole/l/s               mole/l/s            v/v  v/v
       !
       !
       ! And we multiply rate by (LWC * R * T / P) in order to
       ! convert unit from mole/l/s to v/v/s
       !
       ! Finally we come to
       !
       !    d[SO4=]
       !    ------- = KaqH2O2 [SO2][H2O2],
       !      dt
       !
       ! where
       !
       !   KaqH2O2 = k K1 hSO2 hH2O2 xSO2 xH2O2 P LWC R T,
       !
       ! this new rate corresponds to a typical second order
       ! reaction of which analytical (integral) solution is
       !
       !   X  = A0 B0 ( exp[(A0-B0) Ka t] - 1 )
       !      / ( A0 exp[(A0-B0) Ka t] - B0 )
       !
       ! inserting variables into solution then we get
       ! [SO4=] =  [SO2][H2O2](exp[([SO2]-[H2O2]) KaqH2O2 t] - 1 )
       !        / ( [SO2] exp[([SO2]-[H2O2]) KaqH2O2 t] - [H2O2] )
       !
       ! Note...Exactly same method can be applied to O3 reaction
       ! in aqueous phase with different rate constants.
       !===========================================================
       
       ! Get concentrations for cloud pH calculation (bec, 12/23/11)
       
       ! <<>><<>><<>><<>>
       ! HAVE TO DO SOME UNIT CONVERSION HERE. THIS ROUTINE IS CALLED 
       ! WITHIN FLEXCHEM_MOD WHERE SPECIES ARE IN MOLEC/CM3
       ! <<>><<>><<>><<>>

       ! Get sulfate concentration and convert from [v/v] to
       ! [moles/liter]
       ! Use a cloud scavenging ratio of 0.7

!       SO4nss  =  Spc(id_SO4) * State_Met%AIRDEN(I,J,L) * &
!            0.7e+0_fp / ( AIRMW * LWC ) +                 &
!            Spc(id_SO4s) * State_Met%AIRDEN(I,J,L)  &
!            / ( AIRMW * LWC )

       SO4nss  =  1.e+3 * ( Spc(id_SO4) * 0.7e+0_fp + Spc(id_SO4s) ) / &
            ( LWC * AVO ) ! mcl/cm3 -> mol/L

       IF ( IS_FULLCHEM .and. id_HMS > 0 ) THEN
          ! Get HMS cloud concentration and convert from [v/v] to
          ! [moles/liter] (jmm, 06/13/2018)
          ! Use a cloud scavenging ratio of 0.7 
          ! assume nonvolatile like sulfate for realistic cloud pH
          HMSc  =  Spc(id_HMS) * State_Met%AIRDEN(I,J,L) * &
               0.7e+0_fp * CVFAC / ( AIRMW * LWC )
       ELSE
          HMSc = 0e+0_fp
       ENDIF
          
       ! Get total ammonia (NH3 + NH4+) concentration [v/v]
       ! Use a cloud scavenging ratio of 0.7 for NH4+
       TNH3     = ( ( Spc(id_NH4) * 0.7e+0_fp ) + Spc(id_NH3) ) * &
            CVFAC

       ! Get total chloride (SALACL + HCL) concentration [v/v]
       ! Use a cloud scavenging ratio of 0.7
       CL  = ( Spc(id_SALACL) * 0.7e+0_fp ) + &
            Spc(id_SALCCL)
       CL = (CL + Spc(id_HCL)) * CVFAC

       ! Get total formic acid concentration [v/v]
       ! jmm (12/3/18)
       ! no cloud scavenging because gases?
       TFA = Spc(id_HCOOH) * CVFAC

       ! Get total acetic acid concentration [v/v]
       ! jmm (12/3/18)
       ! no cloud scavenging b/c gases?
       TAA = Spc(id_ACTA) * CVFAC

       ! Get total sea salt NVC concentration expressed as NA+ equivalents
       ! and convert from [MND] to [moles/liter]
       ! NVC is calculated to balance initial Cl- + alkalinity in
       ! seas salt. Note that we should not consider SO4ss here.
       ! Use a cloud scavenging ratio of 0.7 for fine aerosols
       TNA      = 1.e3_fp*( Spc(id_SALA)*0.7e+0_fp + Spc(id_SALC) ) * &
            ( 31.6e+0_fp * 0.359e+0_fp / 23.e+0_fp ) / &
            ( LWC * AVO ) ! mcl/cm3 -> mol/L

       ! Get total dust cation concentration [mol/L]
       ! Use a cloud scavenging ratio of 1 for dust
       ! to be consistent for how it was calculated for
       ! metal catalyzed SO2 oxidation
       ! Use asumption of dust being 3% soluble Ca2+ and
       ! 0.6% soluble Mg2+ by mass (Fairlie et al., 2010)
       !
       ! Dust treated at non-volatile cation and charge applied in
       ! pH calculation
       !
       ! Move dust calculation from SO2 Metal catalzyed oxidation
       ! up here becasue needed for cloud pH
       ! jmm (12/3/18)
       !
       ! Get dust concentrations [MND -> ng/m3]

       DUST = ( Spc(id_DST1)*0.7_fp + Spc(id_DST2) +       &
            Spc(id_DST3) + Spc(id_DST4) ) * 1.e+15_fp * &
            State_Chm%SpcData(id_DST1)%Info%MW_g / AVO

       ! Conversion from dust mass to Ca2+ and Mg2+ mol:
       !     0.071*(1/40.08)+0.011*(1/24.31) = 2.22e-3
       !     (Engelbrecht et al., 2016)
       !     1e-12_fp from m3->L & ng->g
       TDCA     = DUST * 2.22e-15_fp / LWC

       ! Get total nitrate (HNO3 + NIT) concentrations [v/v]
       ! Use a cloud scavenging ratio of 0.7 for NIT
       TNO3 = ( Spc(id_HNO3) +             &
              ( Spc(id_NIT)  * 0.7e+0_fp ) + &
              Spc(id_NITs) ) * CVFAC
       GNO3 = Spc(id_HNO3)  * CVFAC ! For Fahey & Pandis decision algorithm

       ! Calculate cloud pH
       CALL GET_HPLUS( SO4nss, HMSc, TNH3, TNO3,  SO2_AfterSS,   CL, TNA, TDCA, &
                       TFA,    TAA,  TK,   PATM,  LWC, HPLUS_45, HPLUS  )

       ! Store the cloud pH quantities
       State_Chm%isCloud(I,J,L)    =  1.0_fp
       State_Chm%pHCloud(I,J,L)    = -1.0_fp * log10(HPLUS)
       State_Chm%QLxpHCloud(I,J,L) = State_Chm%pHCloud(I,J,L)             &
            * State_Met%QL(I,J,L)

       IF ( Input_Opt%LMETALCATSO2 ) THEN

          !--------------------------------------------------------
          ! Metal catalyzed oxidation of SO2 pathway
          !--------------------------------------------------------

          ! Get dust concentrations [v/v -> ng/m3]
#ifdef TOMAS
          ! TOMAS uses its own dust tracers and does not
          ! carry DST1-4.  Set DUST to zero here. (mps, 2/2/18)
          DUST = 0e+0_fp
#endif 
          ! Calculate Fe and Mn natural [ng m-3]
          ! Assume that Fe is 3.5% of total dust mass based on
          ! Taylor and McLennan [1985]
          Fe_nat = DUST * 35e-3_fp
          ! and Mn is 50 times less than Fe based on Desbouefs et al.[2005]
          Mn_nat = Fe_nat / 50e+0_fp

          ! Anthropogenic Fe concentrations [mcl/cm3 -> ng/m3]
          IF ( id_pFe > 0 ) THEN
                Fe_ant = Spc(id_pFe) * CVFAC * &
                         1.e+12_fp * State_Met%AD(I,J,L) &
                         / ( AIRMW / State_Chm%SpcData(id_pFe)%Info%MW_g ) &
                         / State_Met%AIRVOL(I,J,L)
!             Fe_ant = Spc(id_pFe) * 1.e+15_fp * &
!                  State_Chm%SpcData(id_DST1)%Info%MW_g / AVO
          ELSE
             Fe_ant = 0e+0_fp
          ENDIF

          ! Calculate Mn anthropogenic [ng m-3]
          ! assume anthropogenic Mn is 1/30 times anthropogenic Fe
          Mn_ant = Fe_ant / 10e+0_fp

          ! Calculate total Mn and Fe [ng m-3]
          Mn_tot = Mn_ant + Mn_nat
          Fe_tot = Fe_ant + Fe_nat

          ! Convert Mn and Fe [ng m-3] to [mole l-1]

          ! Assume that 50% of Mn is dissolved [Spokes et al., 1994]
          ! Hardcoded MW for Mn
          IF ( LWC > 0e+0_fp ) THEN
             ! Units: ng/m3 * (g/ng) / (g/mol) / (m3 H2O / m3 air) * (m3/L)
             Mn_d = Mn_tot * 1e-9_fp / 54.94e+0_fp / LWC * 1e-3_fp
             Mn_d = Mn_d * 0.5e+0_fp
          ELSE
             Mn_d = 0e+0_fp
          ENDIF

          ! Solubility of Fe is 10% for anthropogenic, and 1% for dust
          IF ( LWC > 0e+0_fp ) THEN
             Fe_d_ant = Fe_ant * 1e-9_fp / &
                  State_Chm%SpcData(id_pFe)%Info%MW_g / &
                  LWC * 1e-3_fp
             Fe_d_nat = Fe_nat * 1e-9_fp / &
                  State_Chm%SpcData(id_pFe)%Info%MW_g / &
                  LWC * 1e-3_fp
             Fe_d     = Fe_d_ant * 0.1e+0_fp + &
                  Fe_d_nat * 0.01e+0_fp
          ELSE
             Fe_d     = 0e+0_fp
          ENDIF

          ! Impose a dependence of Fe speciation on sunlight
          IF ( State_Met%SUNCOS(I,J) > 0e+0_fp ) THEN
             ! Assume 10% of dissolved Fe is in Fe(III)
             !oxidation state during the daytime
             FeIII = Fe_d * 0.1e+0_fp
          ELSE
             ! Assume 90% of dissolved Fe is in Fe(III)
             ! oxidation state during the nighttime
             FeIII = Fe_d * 0.9e+0_fp
          ENDIF
          
          ! Assume that dissolved Mn is in Mn(II) oxidation state all of
          ! the time
          MnII = Mn_d

       ELSE

          ! Set Fe and Mn concentrations to zero
          FeIII = 0.0e+0_fp
          MnII  = 0.0e+0_fp

       ENDIF

       ! Compute aqueous rxn rates for SO2
       CALL AQCHEM_SO2( I, J, L, LWC,     TK,    PATM, &
            SO2_AfterSS, &
            Spc(id_H2O2)*CVFAC, &
            Spc(id_O3)*CVFAC, &
            Spc(id_CH2O)*CVFAC, &
            HPLUS, MnII,    FeIII, &
            KaqH2O2, KaqO3, KaqO3_1, KaqO2, &
            HSO3aq,  SO3aq, &
            KaqHCHO, KaqHMS, KaqHMS2  )

       K_CLD(1) = CloudHet2R( Spc(id_SO2), Spc(id_H2O2), FC, KaqH2O2*CVFAC )
       K_CLD(2) = CloudHet2R( Spc(id_SO2), Spc(id_O3), FC, KaqO3*CVFAC )
       !K_CLD(3) computed below
       K_CLD(4) = CloudHet2R( Spc(id_HMS), Spc(id_CH2O), FC, KaqHCHO*CVFAC )
       K_CLD(5) = CloudHet1R( FC, KaqHMS) ! KaqHMS is pseudo-1st order
       K_CLD(6) = CloudHet2R( Spc(id_HMS), Spc(id_OH), FC, &
            KaqHMS2*State_Met%AIRDEN(I,J,L)*State_Met%AIRDEN(I,J,L)*CVFAC )
       ! In the above, KaqHMS2 is converted from [m^6 kg^-2 s^-1] to [v/v/s]

#ifdef TOMAS
       !%%%%%%%%%%%%%%%%% BUG FIX FOR TOMAS %%%%%%%%%%%%%%%%%%%%%%%
       ! NOTE: TOMAS uses its own dust tracers and does not
       ! carry ALKdst.  Set ALKdst to zero here. (bmy, 1/28/14)
       ALKdst = 0e+0_fp
#else
       
       ! For other simulations, Sum up the contributions from
       ! DST1 thru DST4 tracers into ALKdst. (bmy, 1/28/14)
       ! mcl/cm3 -> ug/m3
       ALKdst = ( Spc(id_DST1) + Spc(id_DST2) +            &
            Spc(id_DST3) + Spc(id_DST4) ) * CVFAC *  &
            1.e+9_fp * State_Met%AD(I,J,L)                       &
            / ( AIRMW / State_Chm%SpcData(id_DST1)%Info%MW_g ) &
            / State_Met%AIRVOL(I,J,L)
#endif
       
       ! mcl/cm3 -> ug/m3
       ALKss  = ( Spc(id_SALA  ) + Spc(id_SALC) ) * CVFAC * &
            1.e+9_fp * State_Met%AD(I,J,L)                       &
            / ( AIRMW / State_Chm%SpcData(id_SALA)%Info%MW_g ) &
            / State_Met%AIRVOL(I,J,L)
       
       ALKds = ALKdst + ALKss
       
       ! Get NH3 concentrations (v/v)
       NH3 = Spc(id_NH3)*CVFAC
       
       ! Initialize
       BULK = 0
       SIZE_RES = 0
       
       ! Fahey and Seinfeld decision algorithm
       IF ( Spc(id_H2O2)*CVFAC > SO2_AfterSS + 1e-9_fp ) THEN
          BULK = 1
       ELSEIF( LWC < 0.1e-6_fp ) THEN !10^-6 coversion from g/m3 --> m3/m3
          SIZE_RES = 1
       ELSEIF( gno3 > NH3 ) THEN
          IF ( SO2_AfterSS >= 5.e-9_fp          .and. &
               H2O20  >= SO20   )                &
               BULK    = 1
          IF ( LWC    >= 0.3e-6_fp         .and. &
               SO2_AfterSS >= 3.e-9_fp          .and. &
               H2O20  >= SO2_AfterSS )                &
               BULK    = 1
          IF ( ALKds  >= 5.e+0_fp          .and. &
               LWC    >= 0.5e-6_fp         .and. &
               H2O20  >= SO2_AfterSS )                &
               BULK    = 1
          IF ( LWC    >= 0.1e-6_fp         .and. &
               gno3   <= (NH3 + 2.e-9_fp) )      &
               BULK    = 1
       ELSEIF( LWC    >= 0.5e-6_fp ) THEN
          IF ( H2O20  >= (0.9e+0_fp * SO2_AfterSS) )  &
               BULK    = 1
          IF ( NH3    <= 1.e-9_fp          .and. &
               ALKds  >= 5.e+0_fp          .and. &
               SO2_AfterSS <= 10.e-9_fp )             &
               BULK    = 1
       ELSEIF( LWC    >= 0.3e-6_fp ) THEN
          IF ( NH3    >= (gno3 + 5.e-9_fp) .and. &
               SO2_AfterSS <= 10.e-9_fp )             &
               BULK    = 1
          IF ( gno3   <= 1.e-9_fp          .and. &
               NH3    >= (gno3 + 2.e-9_fp) )     &
               BULK    = 1
          IF ( gno3   <= 7.e-9_fp          .and. &
               NH3    >= (gno3 + 3.e-9_fp) )     &
               BULK    = 1
          IF ( ALKds  >= 3.e+0_fp          .and. &
               NH3 <= 10e-9_fp             .and. &
               SO2_AfterSS <= 5e-9_fp )               &
               BULK    = 1
          IF ( ALKds  >= 5.e+0_fp          .and. &
               NH3    <= 10.e-9_fp         .and. &
               SO2_AfterSS <= 5.e-9_fp )              &
               BULK    = 1
          IF ( SO2_AfterSS >= 1.5e-9_fp         .and. &
               H2O20  >= SO2_AfterSS )                &
               BULK    = 1
          IF ( NH3    <= 12.e-9_fp         .and. &
               ALKds  >=10.e+0_fp )              &
               BULK    = 1
          IF ( NH3    <= 1.e-9_fp          .and. &
               ALKds  >= 4.e+0_fp          .and. &
               SO2_AfterSS <= 10.e-9_fp )             &
               BULK    = 1
          IF ( NH3    <= 5.e-9_fp          .and. &
               ALKds  >= 6.e+0_fp          .and. &
               SO2_AfterSS <= 10.e-9_fp )             &
               BULK    = 1
          IF ( NH3    <= 7.e-9_fp          .and. &
               ALKds   >-8.e+0_fp          .and. &
               SO2_AfterSS <= 10.e-9_fp )             &
               BULK    = 1
       ELSEIF( LWC    >= 0.1e-6_fp ) THEN
          IF ( NH3    <= 1.e-9_fp          .and. &
               ALKds  >= 5.e+0_fp   )            &
               BULK    = 1
          IF ( NH3    <= 5.e-9_fp          .and. &
               ALKds  >= 10.e+0_fp  )            &
               BULK    = 1
          IF ( gno3   <= 1.e-9_fp          .and. &
               NH3    >= (gno3 + 2.e-9_fp) .and. &
               SO2_AfterSS <= 7.e-9_fp )              &
               BULK    = 1
          IF ( gno3   <= 1.e-9_fp          .and. &
               NH3    >= (gno3 + 2.e-9_fp) .and. &
               ALKds  >= 2.e+0_fp )              &
               BULK = 1
          IF ( gno3   <= 3.e-9_fp          .and. &
               NH3    >= (gno3 + 4.e-9_fp) )     &
               BULK    = 1
          IF ( gno3   <= 7.e-9_fp          .and. &
               NH3    >= (gno3 + 3.e-9_fp) .and. &
               SO2_AfterSS <= 5.e-9_fp )              &
               BULK    = 1
          IF ( gno3   <= 7.e-9_fp          .and. &
               NH3    >= (gno3 + 3.e-9_fp) .and. &
               ALKds  >= 4.e+0_fp          .and. &
               SO2_AfterSS <= 9.e-9_fp  )             &
               BULK    = 1
          IF ( ALKds  >= 3.e+0_fp          .and. &
               NH3    <= 3.e-9_fp          .and. &
               SO2_AfterSS <= 4.e-9_fp )              &
               BULK    = 1
          IF ( ALKds  >= 5.e+0_fp          .and. &
               SO2_AfterSS <= 5.e-9_fp          .and. &
               NH3    <= 7.e-9_fp )              &
               BULK    = 1
          IF ( NH3    >= (gno3 + 2.e-9_fp) .and. &
               SO2_AfterSS <= 5.e-9_fp )              &
               BULK    = 1
          IF ( NH3    >= (gno3 + 4.e-9_fp) .and. &
               SO2_AfterSS <= 10.e-9_fp )             &
               BULK    = 1
          IF ( ALKds  >= 2.e+0_fp          .and. &
               NH3    <= 10.e-9_fp         .and. &
               H2O20  >= SO2_AfterSS )                &
               BULK    = 1
          IF ( NH3    <= 1.e-9_fp          .and. &
               SO2_AfterSS >= 3.e-9_fp          .and. &
               H2O20  >= SO2_AfterSS )                &
               BULK    = 1
       ELSE
          SIZE_RES = 1
       ENDIF

       !### BMY NOTE: L2S, L3S, L4S, L5S, L6S are undefined
       !### so set them to zero for now.  MSL can fix (bmy, 6/4/21)
       L2S = 0.0_fp
       L3S = 0.0_fp
       L4S = 0.0_fp
       L5S = 0.0_fp
       L6S = 0.0_fp

       ! Decide whether or not to perform sulfate production rate
       ! enhancement due to cloud drop heterogenity in pH over the oceans
       ! (bec, 12/23/11)
       IF ( SIZE_RES == 1  .AND. State_Met%IsWater(I,J)   .AND.  &
            TK > 268.15_fp .and. FC > 0.0_fp             ) THEN

          ! Get total in-cloud sulfate production based on bulk cloud pH
          ! calculations for use in HET_DROP_CHEM
          LSTOT = (L2S + L3S + L4S + L5S + L6S) / FC !(qjc, 06/20/16)

          ! Get coarse-mode sea-salt concentration for use in
          ! HET_DROP_CHEM [v/v]
          ! Note that it is better to use coarse sea salt alkalinity
          ! tracer if it is being transported (bec, 12/23/11)
          SSCvv  = Spc(id_SALC)*CVFAC

          ! Get sulfate concentrations for use in HET_DROP_CHEM [v/v]
          aSO4  =  Spc(id_SO4)*CVFAC

          ! This is to make sure HET_DROP_CHEM does not compute more
          ! sulfate then there is SO2
          ! Add L5S (qjc, 11/04/16)
          SO2_sr = MAX( SO2_AfterSS - ( L2S + L3S + L4S + L5S + L6S ), MINDAT)

          !! <<>> SET THE INPUT UNITS! EITHER CONVERT IN THE ROUTINE OR
          !! <<>> CONVERT BEFOREHAND. BUT EVERYTHING IS CURRENTLY mcl/cm3
          !! <<>> AND HET_DROP_CHEM EXPECTS V/V

          CALL HET_DROP_CHEM( I,    J,   L,      LSTOT, SSCvv, &
               aSO4, NH3, Spc(id_SO2)*CVFAC, Spc(id_H2O2)*CVFAC, &
               GNO3,  SR, Input_Opt, State_Met, State_Chm )

          KaqO2 = KaqO2 + ( SR/(Spc(id_SO2)*CVFAC*DTCHEM) ) !1/s

       ENDIF

       ! Store HSO3aq, SO3aq for use in gckpp_HetRates.F90
       State_Chm%HSO3_AQ(I,J,L) = HSO3aq * 1.e-3*AVO/LWC ! mol/L -> mcl/cm3  !!*(1+rSIV)/2
       State_Chm%SO3_AQ(I,J,L)  = SO3aq  * 1.e-3*AVO/LWC ! mol/L -> mcl/cm3  !! *(1+rSIV)/2

       K_CLD(3) = CloudHet1R( FC, KaqO2 )
    ELSE

       ! Otherwise, don't do aqueous chemistry, and
       ! save the original concentrations into SO2 and H2O2
       HPLUS        = 0.e+0_fp

       ! Store HSO3aq, SO3aq for use in gckpp_HetRates.F90
       ! Avoid divide-by-zero errors
       State_Chm%HSO3_AQ(I,J,L)     = 1.0e-32_fp
       State_Chm%SO3_AQ(I,J,L)      = 1.0e-32_fp
       
    ENDIF

!>>    !=================================================================
!>>    ! HISTORY (aka netCDF diagnostics)
!>>    !=================================================================
!>>
!>>    ! P(SO4) from gas-phase oxidation [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromGasPhase ) THEN
!>>       State_Diag%ProdSO4fromGasPhase(I,J,L) = &
!>>            ( L1  * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) from aqueous-phase oxidation with H2O2 [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromH2O2inCloud ) THEN
!>>       State_Diag%ProdSO4fromH2O2inCloud(I,J,L) = &
!>>            ( L2S * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) from aqueous-phase oxidation with O3 [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromO3InCloud ) THEN
!>>       State_Diag%ProdSO4fromO3InCloud(I,J,L) = &
!>>            ( ( L3S + SRo3 ) * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) from aqueous-phase oxidation with HOBr [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromHOBrInCloud ) THEN
!>>       State_Diag%ProdSO4fromHOBrInCloud(I,J,L) = &
!>>            ( ( L5S + SRhobr ) * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) from aqueous-phase oxidation with O2 metal-catalyzed
!>>    ! [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromO2InCloudMetal ) THEN
!>>       State_Diag%ProdSO4fromO2InCloudMetal(I,J,L) = &
!>>            ( L4S * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) from O3 in sea salt aerosol [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromO3inSeaSalt ) THEN
!>>       State_Diag%ProdSO4fromO3inSeaSalt(I,J,L) = &
!>>            ( ( PSO4E + PSO4F ) * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) by SRo3 [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromSRO3 ) THEN
!>>       State_Diag%ProdSO4fromSRO3(I,J,L) = &
!>>            ( SRo3 * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) by SRhobr [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromSRHOBr ) THEN
!>>       State_Diag%ProdSO4fromSRHOBr(I,J,L) = &
!>>            ( SRhobr * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    ! P(SO4) by o3s [kg S/s]
!>>    IF ( State_Diag%Archive_ProdSO4fromO3s ) THEN
!>>       State_Diag%ProdSO4fromO3s(I,J,L) = &
!>>            ( L3S_1 * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>    ENDIF
!>>
!>>    !-----------------------------------------------------------
!>>    ! Diagnostics for acid uptake on dust aerosol simulations
!>>    !-----------------------------------------------------------
!>>    IF ( Input_Opt%LDSTUP ) THEN
!>>
!>>       ! Zero
!>>       PSO4d_tot   = 0.e+0_fp
!>>       PH2SO4d_tot = 0.e+0_fp
!>>       PNITd_tot   = 0.e+0_fp
!>>
!>>       DO IBIN = 1, NDSTBIN
!>>          PSO4d_tot   = PSO4d_tot   + PSO4_d(IBIN)
!>>          PNITd_tot   = PNITd_tot   + PNIT_d(IBIN)
!>>          PH2SO4d_tot = PH2SO4d_tot + PH2SO4_d(IBIN)
!>>       END DO
!>>
!>>       ! P(SO4) from O3 oxidation on dust aerosols [kg S/s]
!>>       IF ( State_Diag%Archive_ProdSO4fromOxidationOnDust ) THEN
!>>          State_Diag%ProdSO4fromOxidationOnDust(I,J,L) = &
!>>               ( PSO4d_tot * State_Met%AD(I,J,L) / TCVV_S ) / DTCHEM
!>>       ENDIF
!>>
!>>       ! P(NIT) from HNO3 uptake on dust [kg N/s]
!>>       IF ( State_Diag%Archive_ProdNITfromHNO3uptakeOnDust ) THEN
!>>          State_Diag%ProdNITfromHNO3uptakeOnDust(I,J,L) = &
!>>               ( PNITd_tot * State_Met%AD(I,J,L) / TCVV_N ) / DTCHEM
!>>       ENDIF
!>>
!>>       ! P(SO4) from uptake of H2SO4 on dust aerosols [kg S/s]
!>>       IF ( State_Diag%Archive_ProdSO4fromUptakeOfH2SO4g ) THEN
!>>          State_Diag%ProdSO4fromUptakeOfH2SO4g(I,J,L) = &
!>>               ( PH2SO4d_tot * State_Met%AD(I,J,L) / TCVV_S )/DTCHEM
!>>       ENDIF
!>>       ENDIF

    ! Free pointers
    Spc     => NULL()
    SSAlk   => NULL()

  END SUBROUTINE SET_SO2
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: get_hplus
!
! !DESCRIPTION: Subroutine GET\_HPLUS computes H+ concentrations in cloud
!  liquid water for pH dependent cloud chemistry. (bec, 4/11/11)
!\\
!\\
! !INTERFACE:
!
    SUBROUTINE GET_HPLUS( SO4nss, HMSc, TNH3, TNO3, SO2, CL, TNA, TDCA, TFA, &
                          TAA,  T, PRES, LWC,  iHPLUS, HPLUS )
!
! !USES:
!
    USE ERROR_MOD,       ONLY : IT_IS_NAN, GEOS_CHEM_STOP
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN)    :: SO4nss ! Total nss sulfate mixing ratio [M]
    REAL(fp),  INTENT(IN)    :: HMSc ! Total HMS mixing ratio [M]    
    REAL(fp),  INTENT(IN)    :: TNO3   ! Total nitrate (gas+particulate) mixing
                                       ! ratio [v/v]
    REAL(fp),  INTENT(IN)    :: TNH3   ! NH3 mixing ratio [v/v]
    REAL(fp),  INTENT(IN)    :: SO2    ! SO2 mixing ratio [v/v]
    REAL(fp),  INTENT(IN)    :: CL     ! Total chloride (gas+particulate) mixing
    REAL(fp),  INTENT(IN)    :: TNA    ! Sodium (particulate) [v/v]
    REAL(fp),  INTENT(IN)    :: TDCA   ! Total Ca2+ and Mg2+ mixing ratio [M] ! jmm 12/3/18
    REAL(fp),  INTENT(IN)    :: TAA    ! Acetic acid mixing ratio [v/v] ! jmm 12/3/18
    REAL(fp),  INTENT(IN)    :: TFA    ! Formic acid mixing ratio [v/v] ! jmm 12/3/18
    REAL(fp),  INTENT(IN)    :: T      ! Temperature [K]
    REAL(fp),  INTENT(IN)    :: PRES   ! Dry air partial ressure [atm]
    REAL(fp),  INTENT(IN)    :: LWC    ! Cloud liquid water content [m3/m3]
    REAL(fp),  INTENT(IN)    :: iHPLUS ! Initial [H+] [M]
!
! !OUTPUT PARAMETERS:
!
    REAL(fp),  INTENT(OUT)   :: HPLUS  ! Calculated [H+] [M]
! !REMARKS:
!  Calculation:
!  ============================================================================
!  Solve the following electroneutrality equation:
!  [H+] = 2[SO4--] + [Cl-] + [OH-] + [HCO3-] + 2[CO3--] + [HSO3-] + 2[SO3--] +!
!          [NO3-] + [HCOO-] + [CH3COO-] - [Na] - 2[Ca] - [NH4]
!  Uses Newton's method to solve the equation:
!     x_1 = x_0 -f(x_0)/f'(x_0)
!     iterate until converge
!
!  Let concentrations of [HCO3], [CO3], [HSO3], [SO3], [NO3] and [NH4] evolve
!  according to Henry's law equilibrium.
!
!  To add new species:
!    - Add species not affected by HPLUS to the "D' term
!    - Add species that disassociate once using the kHNO3 and dkHNO3
!    functions
!      as a template
!    - Add species that disassociate twice using the kSO21 and dkSO21
!    functions
!      as a template for the single charged ion and kSO22 and dkSO22
!      functions for
!      the double charged ion

!  Assume [S(VI)] = [SO4]nss (this applies for pH > 3)
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! Water dissociation constants
    REAL(fp),  PARAMETER   :: Kw   = 1.0e-14_fp
    REAL(fp),  PARAMETER   :: DhrKw = -6710.e+0_fp
    REAL(fp),  PARAMETER   :: MINVAL = 0.01
!
! !LOCAL VARIABLES:
!
    REAL(fp)               :: D, Kw_T, ipH, newpH, nHPLUS
    REAL(fp)               :: fHCO3, fCO3
    REAL(fp)               :: fHSO3, fSO3
    REAL(fp)               :: fHNO3, fNH4, fHCl
    REAL(fp)               :: dHCO3, dCO3
    REAL(fp)               :: dHSO3, dSO3
    REAL(fp)               :: dHNO3, dNH4, dHCl
    REAL(fp)               :: fAA, fFA, dAA, dFA
    REAL(fp)               :: f, df, nnHPLUS, fCa, dCa
    INTEGER                :: count

    !=================================================================
    ! GET_HPLUS begins here!
    !=================================================================

    ! Initial pH guess
    ipH = -log10(iHPLUS)

    ! Non-volatile aerosol concentration [M]
    ! For now sulfate is the only non-volatile species
    D = (2.e+0_fp*SO4nss) - TNA - (2.e+0_fp*TDCA) + (1.e+0_fp * HMSc)

    ! Temperature dependent water equilibrium constant
    Kw_T = Kw*exp(DhrKw*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

    ! Initialize
    newpH   = 0.0
    COUNT = 0

    DO WHILE ( ABS(ipH-newpH) .gt. MINVAL )

       COUNT = COUNT+1

       IF ( COUNT .EQ. 1 ) THEN
          ipH = ipH
       ELSE
          ipH = newpH
       ENDIF

       nHPLUS = 10.e+0_fp**(-ipH)

       ! Get f(x) terms
       fHCO3  = kCO21 ( PRES, T, LWC, nHPLUS )

       fCO3 = kCO22 ( PRES, T, LWC, nHPLUS )

       fHSO3  = kSO21 ( PRES, T, LWC, nHPLUS, SO2 )

       fSO3 = kSO22 ( PRES, T, LWC, nHPLUS, SO2 )

       fHNO3 = kHNO3 ( PRES, T, LWC, nHPLUS, TNO3 )

       fNH4  = kNH3  ( PRES, T, LWC, nHPLUS, TNH3, Kw_T )

       ! include HCl in cloud pH calculations, xnw 10/17/17
       fHCl  = kHCl  ( PRES, T, LWC, nHPLUS, CL  )

       fFA   = kFA   ( PRES, T, LWC, nHPLUS, TFA ) ! jmm 12/3/18

       fAA   = kAA   ( PRES, T, LWC, nHPLUS, TAA ) ! jmm 12/3/18

       ! Get f'(x) terms
       dHCO3  = dkCO21 ( PRES, T, LWC, nHPLUS )

       dCO3 = dkCO22 ( PRES, T, LWC, nHPLUS )

       dHSO3  = dkSO21 ( PRES, T, LWC, nHPLUS, SO2 )

       dSO3 = dkSO22 ( PRES, T, LWC, nHPLUS, SO2 )

       dHNO3 = dkHNO3 ( PRES, T, LWC, nHPLUS, TNO3 )

       dNH4  = dkNH3  ( PRES, T, LWC, nHPLUS, TNH3, Kw_T )

       dHCl = dkHCl ( PRES, T, LWC, nHPLUS, CL )

       dFA   = dkFA   ( PRES, T, LWC, nHPLUS, TFA ) ! jmm 12/3/18

       dAA   = dkAA   ( PRES, T, LWC, nHPLUS, TAA ) ! jmm 12/3/18
       ! Calculate [Ca2+] in equilibrium with CaCO3(s)
       CALL CaCO3_PRECIP ( PRES, T, nHPLUS, fCa, dCa )

       ! if [Ca2+] in equilibrium with CacO3(s) is greater than total [Ca2+]
       ! then all Ca is dissolved else [Ca2+] varies with [H+]
       IF ( fCa .ge. TDCA ) THEN
          ! Non-volatile aerosol concentration [M]
          D = (2.e+0_fp*SO4nss) - (TNA+2.e+0_fp*TDCA)

          ! Define f(x)
          f = D - nHPLUS + Kw/nHPLUS + fHCO3 + 2.e+0_fp * &
               fCO3 + fHSO3 + 2.e+0_fp * fSO3 + fHNO3 - fNH4 + &
               fHCl + fFA + fAA

          ! Define f'(x)
          df = - 1.d0 - Kw/nHPLUS/nHPLUS + dHCO3 + 2.e+0_fp * &
               dCO3 + dHSO3 + 2.e+0_fp * dSO3 + dHNO3 - dNH4 + &
               dHCl + dFA + dAA

       ELSE
          ! Non-volatile aerosol concentration [M]
          D = (2.e+0_fp * SO4nss) - TNA

          ! Define f(x)
          f = D - nHPLUS + Kw/nHPLUS + fHCO3 + 2.e+0_fp * fCO3 + &
               fHSO3 + 2.e+0_fp * fSO3 + fHNO3 - fNH4 + &
               fHCl + fFA + fAA - 2.e+0_fp * fCa
          ! Define f'(x)
          df = - 1.d0 - Kw/nHPLUS/nHPLUS + dHCO3 + 2.e+0_fp * dCO3 + &
               dHSO3 + 2.e+0_fp * dSO3 + dHNO3 - dNH4 + &
               dHCl + dFA + dAA - 2.e+0_fp * dCa
       ENDIF

       ! Apply Newton's method
       nnHPLUS = nHPLUS - f/df

       ! Set minimum [H+] = 1.d-14 (pH = 14)
       nnHPLUS = MAX(nnHPLUS,1.0e-14_fp)

       ! Set maximum [H+] = 1.d-1 (pH = 1)
       nnHPLUS = MIN(nnHPLUS,1.0e-1_fp)

       ! If solution does not converge after 50 iterations
       ! average last 2 pH calculations
       IF (count > 50) THEN
          newpH = ((-log10(nnHPLUS)) + (-log10(nHPLUS))) / 2.0e+0_fp

          IF (IT_IS_NAN( newpH )) THEN
             write(6,*) 'newpH = ', newpH
             write(6,*) 'nnHPLUS = ', nnHPLUS
             write(6,*) 'nHPLUS = ', nHPLUS
             CALL GEOS_CHEM_STOP
          ENDIF

          EXIT
       ELSE
          newpH = -log10(nnHPLUS)

          IF (IT_IS_NAN( newpH )) THEN
             write(6,*) 'newpH = ', newpH
             write(6,*) 'nnHPLUS = ', nnHPLUS
             CALL GEOS_CHEM_STOP
          ENDIF

       ENDIF

    ENDDO

    HPLUS = 10.0e+0_fp**(-newpH)

  END SUBROUTINE GET_HPLUS
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kCO21
!
! !DESCRIPTION: Function kCO21
!\\
!\\
! !INTERFACE:
!
  FUNCTION kCO21 ( P, T, LWC, HPLUS ) RESULT ( KCO2p )
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS
!
! !OUTPUT PARAMETERS:
!
    REAL(fp)              :: KCO2p, KCO2p2
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! CO2 dissociation constants
    REAL(fp),  PARAMETER  :: Kc1 = 4.3e-7
    REAL(fp),  PARAMETER  :: Kc2 =4.68e-11
    REAL(fp),  PARAMETER  :: DhrKc1 = -1000.
    REAL(fp),  PARAMETER  :: DhrKc2 = -1760.
    REAL(fp),  PARAMETER  :: Hco2 = 3.4e-2
    REAL(fp),  PARAMETER  :: Dhco2 = 2.44e+3_fp
    ! CO2 concentration [v/v]
    REAL(fp),  PARAMETER  :: CO2 = 390.0e-6_fp
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: Hco2_T, Kc1_T, Kc2_T
    REAL(fp)              :: Hco2eff, xCO2, pCO2

    !=================================================================
    ! kCO21 begins here!
    !=================================================================

    !CO2 dissolution constants
    Hco2_T  = Hco2*exp(Dhco2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Kc1_T   = Kc1*exp(DhrKc1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Kc2_T   = Kc2*exp(DhrKc2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

    !CO2 dissolution
    Hco2eff = Hco2_T*(1.e+0_fp+(Kc1_T/HPLUS)+((Kc1_T*Kc2_T)/(HPLUS*HPLUS)))
    xCO2    = 1.e+0_fp / ( 1.e+0_fp + ( Hco2eff * 0.08205e+0_fp * T * LWC ) )
    pCO2    = CO2 * P * xCO2

    KCO2p  = Hco2_T / HPLUS * Kc1_T * pCO2

  END FUNCTION kCO21
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkCO21
!
! !DESCRIPTION: Function dkCO21
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkCO21 ( P, T, LWC, HPLUS ) RESULT ( KCO2p )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KCO2p, KCO2p2
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  22 Mar 2017 - M. Sulprizio- Dhco2 value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (V. Shah)
!  15 Feb 2019 - J. Moch     - updated function to make output
!  derivative of [HCO3-]
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! CO2 dissociation constants
      REAL(fp),  PARAMETER  :: Kc1 = 4.3e-7
      REAL(fp),  PARAMETER  :: Kc2 =4.68e-11
      REAL(fp),  PARAMETER  :: DhrKc1 = -1000.
      REAL(fp),  PARAMETER  :: DhrKc2 = -1760.
      REAL(fp),  PARAMETER  :: Hco2 = 3.4e-2
      REAL(fp),  PARAMETER  :: Dhco2 = 2.44e+3_fp
      ! CO2 concentration [v/v]
      REAL(fp),  PARAMETER  :: CO2 = 390.0e-6_fp
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hco2_T, Kc1_T, Kc2_T

! !REMARKS:

      !=================================================================
      ! dkCO21 begins here!
      !=================================================================

      !CO2 dissolution constants
      Hco2_T = Hco2*exp(Dhco2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Kc1_T = Kc1*exp(DhrKc1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Kc2_T = Kc2*exp(DhrKc2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

      !CO2 dissolution

      KCO2p  = Kc1_T * Hco2_T * CO2 * P * ( Kc1_T * Kc2_T * Hco2_T * &
          0.08205e+0_fp * T * LWC - Hco2_T * 0.08205e+0_fp * T *     &
          LWC * HPLUS * HPLUS - HPLUS * HPLUS) / (Kc1_T * Kc2_T *    &
          Hco2_T * 0.08205e+0_fp * T * LWC + Kc1_T * Hco2_T *        &
          0.08205e+0_fp * T * LWC * HPLUS + Hco2_T * 0.08205e+0_fp * &
          T * LWC * HPLUS * HPLUS + HPLUS * HPLUS)**2

      END FUNCTION dkCO21
!EOC

!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kCO22
!
! !DESCRIPTION: Function kCO22
!\\
!\\
! !INTERFACE:
!
  FUNCTION kCO22 ( P, T, LWC, HPLUS ) RESULT ( KCO2p2 )
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS
!
! !OUTPUT PARAMETERS:
!
    REAL(fp)              :: KCO2p, KCO2p2
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! CO2 dissociation constants
    REAL(fp),  PARAMETER  :: Kc1 = 4.3e-7
    REAL(fp),  PARAMETER  :: Kc2 =4.68e-11
    REAL(fp),  PARAMETER  :: DhrKc1 = -1000.
    REAL(fp),  PARAMETER  :: DhrKc2 = -1760.
    REAL(fp),  PARAMETER  :: Hco2 = 3.4e-2
    REAL(fp),  PARAMETER  :: Dhco2 = 2.44e+3_fp
    ! CO2 concentration [v/v]
    REAL(fp),  PARAMETER  :: CO2 = 390.0e-6_fp
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: Hco2_T, Kc1_T, Kc2_T
    REAL(fp)              :: Hco2eff, xCO2, pCO2

    !=================================================================
    ! kCO22 begins here!
    !=================================================================

    !CO2 dissolution constants
    Hco2_T  = Hco2*exp(Dhco2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Kc1_T   = Kc1*exp(DhrKc1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Kc2_T   = Kc2*exp(DhrKc2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

    !CO2 dissolution
    Hco2eff = Hco2_T*(1.e+0_fp+(Kc1_T/HPLUS)+((Kc1_T*Kc2_T)/(HPLUS*HPLUS)))
    xCO2    = 1.e+0_fp / ( 1.e+0_fp  + ( Hco2eff * 0.08205e+0_fp * T * LWC ) )
    pCO2    = CO2 * P * xCO2

    KCO2p2 = Kc1_T * Kc2_T * Hco2_T / HPLUS / HPLUS * pCO2

  END FUNCTION kCO22
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkCO22
!
! !DESCRIPTION: Function dkCO22
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkCO22 ( P, T, LWC, HPLUS ) RESULT ( KCO2p2 )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KCO2p, KCO2p2
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  22 Mar 2017 - M. Sulprizio- Dhco2 value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (V. Shah)
!  15 Feb 2019 - J. Moch     - updated function to make output deriviate
!  of [CO3--]
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! CO2 dissociation constants
      REAL(fp),  PARAMETER  :: Kc1 = 4.3e-7
      REAL(fp),  PARAMETER  :: Kc2 =4.68e-11
      REAL(fp),  PARAMETER  :: DhrKc1 = -1000.
      REAL(fp),  PARAMETER  :: DhrKc2 = -1760.
      REAL(fp),  PARAMETER  :: Hco2 = 3.4e-2
      REAL(fp),  PARAMETER  :: Dhco2 = 2.44e+3_fp
      ! CO2 concentration [v/v]
      REAL(fp),  PARAMETER  :: CO2 = 390.0e-6_fp
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hco2_T, Kc1_T, Kc2_T

      !=================================================================
      ! dkCO22 begins here!
      !=================================================================

      !CO2 dissolution constants
      Hco2_T = Hco2*exp(Dhco2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Kc1_T = Kc1*exp(DhrKc1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Kc2_T = Kc2*exp(DhrKc2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

      !CO2 dissolution

      KCO2p2 = -1.e+0_fp * Kc1_T * Kc2_T * Hco2_T * CO2 * P * ( Kc1_T * &
           Hco2_T * 0.08205e+0_fp * T * LWC + 2.0e+0_fp * Hco2_T *      &
           0.08205e+0_fp * T * LWC * HPLUS + 2.0e+0_fp * HPLUS ) /      &
           ( Kc1_T * Kc2_T * Hco2_T * 0.08205e+0_fp * T * LWC +         &
           Kc1_T * Hco2_T * 0.08205e+0_fp * T * LWC * HPLUS +           &
           Hco2_T *0.08205e+0_fp * T * LWC * HPLUS * HPLUS +            &
           HPLUS * HPLUS )**2

      END FUNCTION dkCO22
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kSO21
!
! !DESCRIPTION: Function kSO21
!\\
!\\
! !INTERFACE:
!
  FUNCTION kSO21 ( P, T, LWC, HPLUS, SO2 ) RESULT ( KSO2p )
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, SO2
!
! !OUTPUT PARAMETERS:
!
    REAL(fp)              :: KSO2p, KSO2p2
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! SO2 dissociation constants
    REAL(fp),  PARAMETER  :: Ks1 = 1.3e-2
    REAL(fp),  PARAMETER  :: Ks2 = 6.6e-8
    REAL(fp),  PARAMETER  :: Hso2 = 1.23
    REAL(fp),  PARAMETER  :: Dhso2 = 3.14e+3_fp
    REAL(fp),  PARAMETER  :: DhrKso21 = 1960.
    REAL(fp),  PARAMETER  :: DhrKso22 = 1500.
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: Hso2_T, Ks1_T, Ks2_T
    REAL(fp)              :: Hso2eff, xSO2, pSO2

    !=================================================================
    ! kSO21 begins here!
    !=================================================================

    ! SO2 dissolution constants
    Hso2_T  = Hso2*exp(Dhso2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Ks1_T   = Ks1*exp(DhrKso21*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Ks2_T   = Ks2*exp(DhrKso22*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

    ! SO2 dissolution
    Hso2eff = Hso2_T*(1.e+0_fp+(Ks1_T/HPLUS)+((Ks1_T*Ks2_T)/(HPLUS*HPLUS)))
    xSO2    = 1.e+0_fp / ( 1.e+0_fp  + ( Hso2eff * 0.08205e+0_fp * T * LWC ) )
    pSO2    = SO2 * P * xSO2

    KSO2p   = Hso2_T * Ks1_T * pSO2 / HPLUS

  END FUNCTION kSO21
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkSO21
!
! !DESCRIPTION: Function dkSO21
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkSO21 ( P, T, LWC, HPLUS, SO2 ) RESULT ( KSO2p )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, SO2
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KSO2p, KSO2p2
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  22 Mar 2017 - M. Sulprizio- Dhso2 value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (V. Shah)
!  15 Feb 2019 - J. Moch     - updated function to make output
!  derivative of [HSO3-]

!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! SO2 dissociation constants
      REAL(fp),  PARAMETER  :: Ks1 = 1.3e-2
      REAL(fp),  PARAMETER  :: Ks2 = 6.6e-8
      REAL(fp),  PARAMETER  :: Hso2 = 1.23
      REAL(fp),  PARAMETER  :: Dhso2 = 3.14e+3_fp
      REAL(fp),  PARAMETER  :: DhrKso21 = 1960.
      REAL(fp),  PARAMETER  :: DhrKso22 = 1500.
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hso2_T, Ks1_T, Ks2_T

      !=================================================================
      ! dkSO21 begins here!
      !=================================================================



      ! SO2 dissolution constants
      Hso2_T = Hso2*exp(Dhso2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Ks1_T = Ks1*exp(DhrKso21*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Ks2_T = Ks2*exp(DhrKso22*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))


      KSO2p  = Ks1_T * Hso2_T * SO2 * P * ( Ks1_T * Ks2_T * Hso2_T *  &
           0.08205e+0_fp * T * LWC - Hso2_T * 0.08205e+0_fp * T *     &
           LWC * HPLUS * HPLUS - HPLUS * HPLUS) / (Ks1_T * Ks2_T *    &
           Hso2_T * 0.08205e+0_fp * T * LWC + Ks1_T * Hso2_T *        &
           0.08205e+0_fp * T * LWC * HPLUS + Hso2_T * 0.08205e+0_fp * &
           T * LWC * HPLUS * HPLUS + HPLUS * HPLUS)**2

      END FUNCTION dkSO21
!EOC

!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kSO22
!
! !DESCRIPTION: Function kSO22
!\\
!\\
! !INTERFACE:
!
  FUNCTION kSO22 ( P, T, LWC, HPLUS, SO2 ) RESULT ( KSO2p2 )
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, SO2
!
! !OUTPUT PARAMETERS:
!
    REAL(fp)              :: KSO2p, KSO2p2
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! SO2 dissociation constants
    REAL(fp),  PARAMETER  :: Ks1 = 1.3e-2
    REAL(fp),  PARAMETER  :: Ks2 = 6.6e-8
    REAL(fp),  PARAMETER  :: Hso2 = 1.23
    REAL(fp),  PARAMETER  :: Dhso2 = 3.14e+3_fp
    REAL(fp),  PARAMETER  :: DhrKso21 = 1960.
    REAL(fp),  PARAMETER  :: DhrKso22 = 1500.
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: Hso2_T, Ks1_T, Ks2_T
    REAL(fp)              :: Hso2eff, xSO2, pSO2

    !=================================================================
    ! kSO22 begins here!
    !=================================================================

    ! SO2 dissolution constants
    Hso2_T  = Hso2*exp(Dhso2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Ks1_T   = Ks1 *exp(DhrKso21*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Ks2_T   = Ks2 *exp(DhrKso22*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

    !SO2 dissolution
    Hso2eff = Hso2_T*(1.e+0_fp+(Ks1_T/HPLUS)+((Ks1_T*Ks2_T)/(HPLUS*HPLUS)))
    xSO2    = 1.e+0_fp / ( 1.e+0_fp + ( Hso2eff * 0.08205e+0_fp * T * LWC ) )
    pSO2    = SO2 * P * xSO2

    KSO2p2 = Ks1_T * Ks2_T * Hso2_T / HPLUS / HPLUS * pSO2

  END FUNCTION kSO22
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkSO22
!
! !DESCRIPTION: Function dkSO22
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkSO22 ( P, T, LWC, HPLUS, SO2 ) RESULT ( KSO2p2 )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, SO2
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KSO2p, KSO2p2
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  22 Mar 2017 - M. Sulprizio- Dhso2 value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (V. Shah)
!  15 Feb 2019 - J. Moch     - updated function to make output
!  derivative [SO3--]

!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! SO2 dissociation constants
      REAL(fp),  PARAMETER  :: Ks1 = 1.3e-2
      REAL(fp),  PARAMETER  :: Ks2 = 6.6e-8
      REAL(fp),  PARAMETER  :: Hso2 = 1.23
      REAL(fp),  PARAMETER  :: Dhso2 = 3.14e+3_fp
      REAL(fp),  PARAMETER  :: DhrKso21 = 1960.
      REAL(fp),  PARAMETER  :: DhrKso22 = 1500.
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hso2_T, Ks1_T, Ks2_T

      !=================================================================
      ! dkSO22 begins here!
      !=================================================================
      ! SO2 dissolution constants
      Hso2_T = Hso2*exp(Dhso2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Ks1_T  = Ks1 *exp(DhrKso21*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Ks2_T  = Ks2 *exp(DhrKso22*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

      KSO2p2 = -1.e+0_fp * Ks1_T * Ks2_T * Hso2_T * SO2 * P * ( Ks1_T * &
           Hso2_T * 0.08205e+0_fp * T * LWC + 2.0e+0_fp * Hso2_T *      &
           0.08205e+0_fp * T * LWC * HPLUS + 2.0e+0_fp * HPLUS ) /      &
           ( Ks1_T * Ks2_T * Hso2_T * 0.08205e+0_fp * T * LWC +         &
           Ks1_T * Hso2_T * 0.08205e+0_fp * T * LWC * HPLUS +           &
           Hso2_T *0.08205e+0_fp * T * LWC * HPLUS * HPLUS +            &
           HPLUS * HPLUS )**2

      END FUNCTION dkSO22
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kHNO3
!
! !DESCRIPTION: Function kNO3
!\\
!\\
! !INTERFACE:
!
  FUNCTION kHNO3 ( P, T, LWC, HPLUS, HNO3 ) RESULT ( KHNO3p )
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, HNO3
!
! !OUTPUT PARAMETERS:
!
    REAL(fp)              :: KHNO3p
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! HNO3 dissociation constants
    REAL(fp),  PARAMETER  :: Kn1 = 15.4
    REAL(fp),  PARAMETER  :: Hhno3 = 2.1e5
    REAL(fp),  PARAMETER  :: Dhhno3 = 0.
    REAL(fp),  PARAMETER  :: DhrKn1 = 8700.
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: Hhno3_T, Kn1_T
    REAL(fp)              :: Hhno3eff, xHNO3, pHNO3

    !=================================================================
    ! kHNO3 begins here!
    !=================================================================

    ! HNO3 dissolution constants
    Hhno3_T  = Hhno3*exp(Dhhno3*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Kn1_T    = Kn1*exp(DhrKn1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

    ! HNO3 dissolution
    ! The original Hhno3eff expression is valid for 298K (Seinfeld and Pandis
    ! 2006, pp 299-301), and Kn1 has a strong temperature dependence. The
    ! fix follows Eq. 7.59 of Seinfeld and Pandis (2006, pp 301).
    !Hhno3eff = 3.2e6/HPLUS
    Hhno3eff = Hhno3_T*(1.0e+0_fp+(Kn1_T/HPLUS))
    xHNO3    = 1.e+0_fp / ( 1.e+0_fp + ( Hhno3eff * 0.08205e+0_fp * T * LWC ) )
    pHNO3    = HNO3 * P * xHNO3

    kHNO3p = Hhno3_T * Kn1_T * pHNO3 / HPLUS

  END FUNCTION kHNO3
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkHNO3
!
! !DESCRIPTION: Function dkNO3
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkHNO3 ( P, T, LWC, HPLUS, HNO3 ) RESULT ( KHNO3p )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, HNO3
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KHNO3p
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  22 Mar 2017 - M. Sulprizio- Add fix for Hhno3eff from V. Shah
!  15 Feb 2019 - J. Moch     - updated function to make output
!  derivative of [HNO3-]
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! HNO3 dissociation constants
      REAL(fp),  PARAMETER  :: Kn1 = 15.4
      REAL(fp),  PARAMETER  :: Hhno3 = 2.1e5
      REAL(fp),  PARAMETER  :: Dhhno3 = 0.
      REAL(fp),  PARAMETER  :: DhrKn1 = 8700.
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hhno3_T, Kn1_T

      !=================================================================
      ! dkHNO3 begins here!
      !=================================================================

      ! HNO3 dissolution constants
      Hhno3_T = Hhno3*exp(Dhhno3*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Kn1_T = Kn1*exp(DhrKn1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

      ! HNO3 dissolution
      ! The original Hhno3eff expression is valid for 298K (Seinfeld and
      ! Pandis
      ! 2006, pp 299-301), and Kn1 has a strong temperature dependence.
      ! The
      ! fix follows Eq. 7.59 of Seinfeld and Pandis (2006, pp 301).

      kHNO3p = -1.0e+0_fp * Kn1_T * Hhno3_T * HNO3 * P * &
          ( 1.0e+0_fp + Hhno3_T * 0.08205e+0_fp * T * LWC ) / &
          ( Kn1_T * Hhno3_T * 0.08205e+0_fp * T * LWC + &
          Hhno3_T * 0.08205e+0_fp * T * LWC * HPLUS + &
          HPLUS )**2

      END FUNCTION dkHNO3
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kHCl
!
! !DESCRIPTION: Function kHCl
!\\
!\\
! !INTERFACE:
!
  FUNCTION kHCl ( P, T, LWC, HPLUS, Cl ) RESULT ( KHClp )
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, Cl
!
! !OUTPUT PARAMETERS:
!
    REAL(fp)              :: KHClp
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! HNO3 dissociation constants
    REAL(fp),  PARAMETER  :: Kcl = 1.74e+6_fp
    REAL(fp),  PARAMETER  :: Hcl = 1.5e+3_fp
    REAL(fp),  PARAMETER  :: Dhcl = 2.3e+3_fp
    REAL(fp),  PARAMETER  :: DhrKcl = 6900.e+0_fp
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: Hcl_T, Kcl_T
    REAL(fp)              :: Hcleff, xCl, pHCl

    !=================================================================
    ! kHCl begins here!
    !=================================================================

    ! HCl dissolution constants
    HCl_T  = Hcl*exp(Dhcl*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))
    Kcl_T  = Kcl*exp(DhrKcl*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))

    !HCl dissolution
    Hcleff = Hcl_T*(1.0e+0_fp+(Kcl_T/HPLUS))
    xCl    = 1.0e+0_fp / ( 1.0e+0_fp + ( Hcleff * 0.08205e+0_fp * T * LWC ) )
    pHCl   = Cl * P * xCl

    kHClp  = Hcl_T * Kcl_T * pHCl / HPLUS

  END FUNCTION kHCl
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkHCl
!
! !DESCRIPTION: Function dkHCl
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkHCl ( P, T, LWC, HPLUS, Cl ) RESULT ( KHClp )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, Cl
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KHClp
!
! !REVISION HISTORY:
!  03 Apr 2019 - X. Wang    - Initial version
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! HCl dissociation constants
      REAL(fp),  PARAMETER  :: Kcl = 1.74e+6_fp
      REAL(fp),  PARAMETER  :: Hcl = 1.5e+3_fp
      REAL(fp),  PARAMETER  :: Dhcl = 2.3e+3_fp
      REAL(fp),  PARAMETER  :: DhrKcl = 6900.e+0_fp
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hcl_T, Kcl_T

      !=================================================================
      ! dkHCl begins here!
      !=================================================================

      ! HCl dissolution constants
      Hcl_T = Hcl*exp(Dhcl*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))
      Kcl_T = Kcl*exp(DhrKcl*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))

      ! HCl dissolution
      ! The fix follows Eq. 7.59 of Seinfeld and Pandis (2006, pp 301).

      kHClp = -1.0e+0_fp * Kcl_T * Hcl_T * Cl * P *          &
           ( 1.0e+0_fp + Hcl_T * 0.08205e+0_fp * T * LWC ) / &
           ( Kcl_T * Hcl_T * 0.08205e+0_fp * T * LWC +       &
           Hcl_T * 0.08205e+0_fp * T * LWC * HPLUS +         &
           HPLUS )**2

      END FUNCTION dkHCl
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kNH3
!
! !DESCRIPTION: Function kNH3
!\\
!\\
! !INTERFACE:
!
  FUNCTION kNH3 ( P, T, LWC, HPLUS, NH3, Kw ) RESULT ( KNH3p )
!
! !INPUT PARAMETERS:
!
    REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, NH3, Kw
!
! !OUTPUT PARAMETERS:
!
    REAL(fp)              :: KNH3p
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    ! NH3 dissociation contants
    REAL(fp),  PARAMETER  :: Ka1 = 1.7e-5
    REAL(fp),  PARAMETER  :: Hnh3 = 60.
    REAL(fp),  PARAMETER  :: Dhnh3 = 4200e+0_fp
    REAL(fp),  PARAMETER  :: DhrKa1 = -450.

    ! Variables
    REAL(fp)              :: Hnh3_T, Ka1_T
    REAL(fp)              :: Hnh3eff, xNH3, pNH3

    !=================================================================
    ! kNH3 begins here!
    !=================================================================

    !NH3 dissolution constants
    Hnh3_T  = Hnh3*exp(Dhnh3*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
    Ka1_T   = Ka1*exp(DhrKa1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

    !NH3 dissolution
    Hnh3eff = Hnh3_T*(1.e+0_fp+((Ka1_T* HPLUS) / Kw))
    xNH3    = 1.e+0_fp / ( 1.e+0_fp + ( Hnh3eff * 0.08205e+0_fp * T * LWC ) )
    pNH3    = NH3 * P * xNH3

    KNH3p   = HPLUS * Hnh3_T * Ka1_T * pNH3 / Kw

  END FUNCTION kNH3
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkNH3
!
! !DESCRIPTION: Function dkNH3
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkNH3 ( P, T, LWC, HPLUS, NH3, Kw ) RESULT ( KNH3p )
!

! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, NH3, Kw
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KNH3p
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  22 Mar 2017 - M. Sulprizio- Dhnh3 value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (V. Shah)
!  15 Feb 2019 - J. Moch     - updated function to make output
!  derivative of [NH4+]
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! NH3 dissociation contants
      REAL(fp),  PARAMETER  :: Ka1 = 1.7e-5
      REAL(fp),  PARAMETER  :: Hnh3 = 60.
      REAL(fp),  PARAMETER  :: Dhnh3 = 4200e+0_fp
      REAL(fp),  PARAMETER  :: DhrKa1 = -450.

      ! Variables
      REAL(fp)              :: Hnh3_T, Ka1_T

      !=================================================================
      ! dkNH3 begins here!
      !=================================================================

      !NH3 dissolution constants
      Hnh3_T = Hnh3*exp(Dhnh3*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Ka1_T = Ka1*exp(DhrKa1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

      !NH3 dissolutionnyn

      KNH3p = Ka1_T * Hnh3_T * NH3 * Kw * P * ( 1.0e+0_fp +    &
           Hnh3_T * 0.08205e+0_fp * T * LWC ) /                &
           ( Hnh3_T * 0.08205e+0_fp * T * LWC * ( Kw + Ka1_T * &
           HPLUS ) + Kw)**2

      END FUNCTION dkNH3
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kFA
!
! !DESCRIPTION: Function kFA
!\\
!\\
! !INTERFACE:
!
      FUNCTION kFA ( P, T, LWC, HPLUS, FA ) RESULT ( kFAp )
!

! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, FA
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KFAp
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  17 Oct 2017 - M. Sulprizio- Dhck value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (Qianjie Chen)
!  03 Dec 2018 - J. Moch     - Modified for formic acid (HCOOH). Values
!                              taken from Sienfeld and Pandis. Made it
!                              to output is [FA]
!  01 May 2020 - V. Shah     - Use correct equilibrium constants
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! HCOOH dissociation constants
      REAL(fp),  PARAMETER  :: Kformate = 1.8e-4_fp ! equib const
      REAL(fp),  PARAMETER  :: Hfa = 8800e+0_fp ! henry const
      REAL(fp),  PARAMETER  :: Dhfa = 6100e+0_fp ! henry temp
      REAL(fp),  PARAMETER  :: DhrKfa = 151.e+0_fp ! equib temp
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hfa_T, Kfa_T
      REAL(fp)              :: Hfaeff, xFA, pFA

      !=================================================================
      ! kFA begins here!
      !=================================================================

      ! Formic acid dissolution constants
      HFA_T = Hfa*exp(Dhfa*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))
      Kfa_T = Kformate*exp(DhrKfa*((1.0e+0_fp/T) &
           - (1.0e+0_fp/298.0e+0_fp)))

      !HCOOH  dissolution
      Hfaeff = Hfa_T*(1.0e+0_fp+(Kfa_T/HPLUS))
      xFA = 1.0e+0_fp / ( 1.0e+0_fp &
          + ( Hfaeff * 0.08205e+0_fp * T * LWC ) )
      pFA = FA * P * xFA

      kFAp = Hfa_T * Kfa_T * pFA / HPLUS

      END FUNCTION kFA
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkFA
!
! !DESCRIPTION: Function dkFA
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkFA ( P, T, LWC, HPLUS, FA ) RESULT ( kFAp )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, FA
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KFAp
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  17 Oct 2017 - M. Sulprizio- Dhck value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (Qianjie Chen)
!  03 Dec 2018 - J. Moch     - Modified for formic acid (HCOOH). Values
!  taken from
!                              Sienfeld and Pandis. Made it to output is
!                              [FA]
!  01 May 2020 - V. Shah     - Use correct equilibrium constants
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! HCOOH dissociation constants
      REAL(fp),  PARAMETER  :: Kformate = 1.8e-4_fp ! equib const
      REAL(fp),  PARAMETER  :: Hfa = 8800e+0_fp ! henry const
      REAL(fp),  PARAMETER  :: Dhfa = 6100e+0_fp ! henry temp
      REAL(fp),  PARAMETER  :: DhrKfa = 151.e+0_fp ! equib temp
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Hfa_T, Kfa_T

      !=================================================================
      ! dkFA begins here!
      !=================================================================

      ! Formic acid dissolution constants
      HFA_T = Hfa*exp(Dhfa*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))
      Kfa_T = Kformate*exp(DhrKfa*((1.0e+0_fp/T) &
           - (1.0e+0_fp/298.0e+0_fp)))

      !HCOOH  dissolution

      kFAp = -1.0e+0_fp * Kfa_T * HFA_T * FA * P *           &
           ( 1.0e+0_fp + HFA_T * 0.08205e+0_fp * T * LWC ) / &
           ( Kfa_T * HFA_T * 0.08205e+0_fp * T * LWC +       &
           HFA_T * 0.08205e+0_fp * T * LWC * HPLUS +         &
           HPLUS )**2

      END FUNCTION dkFA
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: kAA
!
! !DESCRIPTION: Function kAA
!\\
!\\
! !INTERFACE:
!
      FUNCTION kAA ( P, T, LWC, HPLUS, AA ) RESULT ( kAAp )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, AA
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KAAp
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  17 Oct 2017 - M. Sulprizio- Dhck value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (Qianjie Chen)
!  03 Dec 2018 - J. Moch     - Modified for acetic acid (CH3COOH).
!  Values taken from
!                              Sienfeld and Pandis, value of [HCOOH]
!  01 May 2020 - V. Shah     - Use correct equilibrium constants
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! CH3HCOOH dissociation constants
      REAL(fp),  PARAMETER  :: Kacetate = 1.75e-5_fp
      REAL(fp),  PARAMETER  :: Haa = 4100e+0_fp
      REAL(fp),  PARAMETER  :: Dhaa = 6200e+0_fp
      REAL(fp),  PARAMETER  :: DhrKaa = 50.0e+0_fp
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Haa_T, Kaa_T
      REAL(fp)              :: Haaeff, xAA, pAA
      !=================================================================
      ! kAA begins here!
      !=================================================================

      ! Formic acid dissolution constants
      HAA_T = Haa*exp(Dhaa*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))
      Kaa_T = Kacetate*exp(DhrKaa*((1.0e+0_fp/T) &
          - (1.0e+0_fp/298.0e+0_fp)))

      !HCOOH  dissolution
      Haaeff = Haa_T*(1.0e+0_fp+(Kaa_T/HPLUS))
      xAA = 1.0e+0_fp / ( 1.0e+0_fp &
         + ( Haaeff * 0.08205e+0_fp * T * LWC ) )
      pAA = AA * P * xAA

      kAAp = Haa_T * Kaa_T * pAA / HPLUS

      END FUNCTION kAA
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: dkAA
!
! !DESCRIPTION: Function kdAA
!\\
!\\
! !INTERFACE:
!
      FUNCTION dkAA ( P, T, LWC, HPLUS, AA ) RESULT ( kAAp )
!
! !INPUT PARAMETERS:
!
      REAL(fp),  INTENT(IN) :: T, P, LWC, HPLUS, AA
!
! !OUTPUT PARAMETERS:
!
      REAL(fp)              :: KAAp
!
! !REVISION HISTORY:
!  25 Jan 2012 - M. Payer    - Added ProTeX headers
!  28 Apr 2015 - E. Lundgren - Input pressure is now dry air partial
!  pressure
!  17 Oct 2017 - M. Sulprizio- Dhck value is from Table 7.3 of Seinfeld
!  and
!                              Pandis (2006, pp 289) and should be
!                              positive for
!                              consistency with the way it is used here.
!                              Also,
!                              the value of R, in units of kcal mol-1
!                              K-1, is
!                              1.986x10^-3, not 0.04. (Qianjie Chen)
!  03 Dec 2018 - J. Moch     - Modified for acetic acid (CH3COOH).
!  Values taken from
!                              Sienfeld and Pandis. Output is
!                              derivative.
!  01 May 2020 - V. Shah     - Use correct equilibrium constants
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! HCOOH dissociation constants
      REAL(fp),  PARAMETER  :: Kacetate = 1.75e-5_fp
      REAL(fp),  PARAMETER  :: Haa = 4100e+0_fp
      REAL(fp),  PARAMETER  :: Dhaa = 6200e+0_fp
      REAL(fp),  PARAMETER  :: DhrKaa = 50.0e+0_fp
!
! !LOCAL VARIABLES:
!
      REAL(fp)              :: Haa_T, Kaa_T
      !=================================================================
      ! kAA begins here!
      !=================================================================

      ! Formic acid dissolution constants
      HAA_T = Haa*exp(Dhaa*((1.0e+0_fp/T)-(1.0e+0_fp/298.0e+0_fp)))
      Kaa_T = Kacetate*exp(DhrKaa*((1.0e+0_fp/T) &
          - (1.0e+0_fp/298.0e+0_fp)))

      !HCOOH  dissolution
      kAAp =  -1.0e+0_fp * Kaa_T * HAA_T * AA * P * &
          ( 1.0e+0_fp + HAA_T * 0.08205e+0_fp * T * LWC ) / &
          ( Kaa_T * HAA_T * 0.08205e+0_fp * T * LWC + &
          HAA_T * 0.08205e+0_fp * T * LWC * HPLUS + &
          HPLUS )**2


      END FUNCTION dkAA
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: CaCO3_PRECIP
!
! !DESCRIPTION: Subroutine CaCO3 to calculate [Ca++] in equilibrium with
! CaCO3(s) (dust particles) depending on [H+]
!\\
!\\
! !INTERFACE:
!
      SUBROUTINE CaCO3_PRECIP ( P,  T, HPLUS, fCa, dCa )
!
! !INPUT PARAMETERS:
!
      REAL(fp),        INTENT(IN) :: T, P, HPLUS
!
! !OUTPUT PARAMETERS:
!
      REAL(fp),  INTENT(OUT):: fCa, dCa ! [Ca2+] and d([Ca2+])/d[H+]
!
! !REVISION HISTORY:
!  25 Dec 2019 - V. Shah - Initial version
!EOP
!------------------------------------------------------------------------------
!BOC
! !DEFINED PARAMETERS:
!
      REAL(fp),  PARAMETER  :: Kc1 = 4.3e-7_fp
      REAL(fp),  PARAMETER  :: Kc2 = 4.68e-11_fp
      REAL(fp),  PARAMETER  :: DhrKc1 = -1000.
      REAL(fp),  PARAMETER  :: DhrKc2 = -1760.
      REAL(fp),  PARAMETER  :: Hco2 = 3.4e-2_fp
      REAL(fp),  PARAMETER  :: Dhco2 = 2.44e+3_fp
      ! CO2 concentration [v/v]
      REAL(fp),  PARAMETER  :: CO2 = 390.0e-6_fp
      REAL(fp),  PARAMETER  :: Ksp = 3.3e-9_fp
      REAL(fp),  PARAMETER  :: DHrKsp = -1200e+0_fp

! !LOCAL VARIABLES:
      REAL(fp)              :: HCO2_T, Kc1_T, Kc2_T, Ksp_T

! !REMARKS:

      !=================================================================
      ! CaCO3_PRECIP begins here!
      !=================================================================
      !Temperature adjusted eq. constants
      !CO2 dissolution constants
      Hco2_T = Hco2*exp(Dhco2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Kc1_T = Kc1*exp(DhrKc1*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))
      Kc2_T = Kc2*exp(DhrKc2*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

      ! CaCO3 eq constants
      Ksp_T = Ksp*exp(DhrKsp*((1.e+0_fp/T)-(1.e+0_fp/298.e+0_fp)))

      !Ca concentrations [M]
      fCa = Ksp_T * HPLUS * HPLUS / (Kc1_T * Kc2_T * Hco2_T * CO2 * P)
      !derivative d[Ca2+]/dH+
      dCa  = 2e+0_fp * Ksp_T * HPLUS / (Kc1_T * Kc2_T * Hco2_T * CO2 * P)

      END SUBROUTINE CaCO3_PRECIP
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: aqchem_so2
!
! !DESCRIPTION: Subroutine AQCHEM\_SO2 computes the reaction rates for aqueous
! SO2 chemistry. (rjp, bmy, 10/31/02, 12/12/02)
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE AQCHEM_SO2( I, J, L, &
                         LWC,     T,     P,       SO2,   H2O2, &
                         O3,      HCHO,  Hplus,   MnII,  FeIII, &
                         KaqH2O2, KaqO3, KaqO3_1, KaqO2, &
                         HSO3aq,  SO3aq, KaqHCHO,  &
                         KaqHMS, KaqHMS2 )
!
! !INPUT PARAMETERS:
!
    INTEGER,  INTENT(IN)  :: I, J, L ! Coordinates, for diagnostic use -- MSL

    REAL(fp), INTENT(IN)  :: LWC     ! Liq water content [m3/m3]=1.E-6*L [g/m3]
    REAL(fp), INTENT(IN)  :: T       ! Temperature [K]
    REAL(fp), INTENT(IN)  :: P       ! Dry air partial pressure [atm]
    REAL(fp), INTENT(IN)  :: SO2     ! SO2  mixing ratio [v/v]
    REAL(fp), INTENT(IN)  :: H2O2    ! H2O2 mixing ratio [v/v]
    REAL(fp), INTENT(IN)  :: O3      ! O3   mixing ratio [v/v]
    REAL(fp), INTENT(IN)  :: HPLUS   ! Concentration of H+ ion (i.e. pH) [v/v]
    REAL(fp), INTENT(IN)  :: MnII    ! Concentration of MnII [mole/l]
    REAL(fp), INTENT(IN)  :: FeIII   ! Concentration of FeIII [mole/l]
    REAL(fp), INTENT(IN)  :: HCHO    ! HCHO   mixing ratio [v/v] (jmm, 06/13/18)
    
!
! !OUTPUT PARAMETERS:
!
    REAL(fp), INTENT(OUT) :: KaqH2O2 ! Reaction rate for H2O2
    REAL(fp), INTENT(OUT) :: KaqO3   ! Reaction rate for O3
    REAL(fp), INTENT(OUT) :: KaqO3_1 ! only the SO3-- oxidation, (qjc, 04/10/16)
    REAL(fp), INTENT(OUT) :: KaqO2   ! Reaction rate for O2 (metal cat)
    REAL(fp), INTENT(OUT) :: KaqHCHO ! Reaction rate for SO2 and HCHO (jmm, 06/13/18)
    REAL(fp), INTENT(OUT) :: KaqHMS  ! Reaction rate for HMS and OH- (jmm, 06/13/18)
    REAL(fp), INTENT(OUT) :: KaqHMS2  ! Reaction rate for HMS and OH(aq) (jmm, 06/28/18)
    REAL(fp), INTENT(OUT) :: HSO3aq  ! Cloud bisulfite [mol/l] (qjc, 06/10/16)
    REAL(fp), INTENT(OUT) :: SO3aq   ! Cloud sulfite   [mol/l] (qjc, 06/10/16)
!
! !REMARKS:
!  Chemical Reactions:
!  ============================================================================
!  (R1) HSO3- + H2O2(aq) + H+ => SO4-- + 2H+ + H2O [Jacob, 1986]
!                                                                             .
!      d[S(VI)]/dt = k[H+][H2O2(aq)][HSO3-]/(1 + K[H+])
!      [Seinfeld and Pandis, 1998, page 366]
!                                                                             .
!  (R2) SO2(aq) + O3(aq) =>
!       HSO3-   + O3(aq) =>
!       SO3--   + O3(aq) =>
!       [Jacob, 1986; Jacobson, 1999]
!                                                                             .
!       d[S(VI)]/dt = (k0[SO2(aq)] + k1[HSO3-] + K2[SO3--])[O3(aq)]
!       [Seinfeld and Pandis, 1998, page 363]
!                                                                             .
!  (R3) HSO3-   + HCHO(aq) => HMS 
!       SO3--   + HCHO(aq) => HMS + OH-
!       [Moch et al., 2018; Olson and Hoffman, 1986]
!                                                                             .
!       d[S(HMS)]/dt = (k1[HSO3-] + k2[SO3--])[HCHO(aq)]
!       [Seinfeld and Pandis, 2016, 309]
!
!  (R4) HMS + OH- => HCHO(aq) + SO3--
!       [Moch et al., 2018; Deister et al., 1986]
!        (note treated as 1st order in contrast to other reactions here)
!
!  (R5) HMS + OH(aq) =(SO2,HO2,O2)=> HCHO + 2SO4-- + O2 + 3H+ + 2H2O
!       [Jacob et al, 1986, Olson and Fessenden, 1992; 
!        Seinfeld and Pandis, 2016, Table 7A.7]
!          Net reaction (R5):
!           HMS + OH(aq) =(O2)=> SO5- + HCHO + H2O
!           HO2 <=> H+ + O2-
!           SO5- + O2- =(H2O)=> HSO5- + OH- + O2
!           SO2(aq) <=> HSO3- + H+
!           H+ + OH- <=> H2O
!           HSO5- + HSO3- => 2SO4-- + 2H+
!
!  Reaction rates can be given as
!       Ra     = k [H2O2(ag)] [S(IV)]  [mole/liter*s]  OR
!       Krate  = Ra LWC R T / P        [1/s]
!                                                                             .
!  Where:
!       LWC = Liquid water content(g/m3)*10-6 [m3(water)/m3(gas)]
!       R   = 0.08205  (atm L / mol-K), Universal gas const.
!       T   = Temperature (K)
!       P   = Pressure (atm)
!                                                                             .
!  Procedure:
!  ============================================================================
!  (a ) Given [SO2] which is assumed to be total SO2 (gas+liquid) in
!        equilibrium between gas and liquid phase.
!                                                                             .
!  (b ) We can compute SO2(g) using Henry's law
!          P(so2(g)) = Xg * [SO2]
!          Xg = 1/(1 + Faq), Fraction of SO2 in gas
!       where:
!          Faq   = Kheff * R * T * LWC,
!          KHeff = Effective Henry's constant
!                                                                             .
!  (c ) Then Calculate Aquous phase, S[IV] concentrations
!        S[IV] = Kheff * P(so2(g) in atm) [M]
!                                                                             .
!  (d ) The exact same procedure is applied to calculate H2O2(aq) and HCHO(aq)
!
! !REVISION HISTORY:
!  (1 ) Updated by Rokjin Park (rjp, bmy, 12/12/02)
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    REAL(fp), PARAMETER   :: R = 0.08205e+0_fp
    REAL(fp), PARAMETER   :: dOH = 1.0e-19_fp ! [M cm^3 molec^-1] (jmm, 06/28/18)    
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: KH2O2,  RA,     KS1, KS2,    HCSO2
    REAL(fp)              :: FHCSO2, XSO2G,  SIV, HSO3,   XSO2AQ
    REAL(fp)              :: XHSO3,  XSO3,   KH1, HCH2O2, FHCH2O2
    REAL(fp)              :: XH2O2G, H2O2aq, KO0, KO1,    KO2
    REAL(fp)              :: HCO3,   XO3g,   O3aq, XHCHOg, HCHCHO ! (jmm, 06/13/18)
    REAL(fp)              :: FHCHCHO,KHCHO1, KHCHO2,  KHMS  ! (jmm, 06/13/18)
    REAL(fp)              :: KW1,    KHC1,   KHMS2          ! (jmm, 06/15/18)    
    

    !=================================================================
    ! AQCHEM_SO2 begins here!
    !
    ! Aqueous reaction rate
    ! HSO3- + H2O2 + H+ => SO4-- + 2H+ + H2O [Jacob, 1986]
    !=================================================================

    ! [Jacob, 1986]
    KH2O2 = 6.31e+14_fp * EXP( -4.76e+3_fp / T )

    !! [Jacobson, 1999]
    !KH2O2 = 7.45e+0_fp7 * EXP( -15.96e+0_fp * ( (298.15/T) - 1.) ) / &
    !        ( 1.e+0_fp + 13.e+0_fp * Hplus)

    !=================================================================
    ! Equilibrium reaction of SO2-H2O
    !    SO2 + H2O = SO2(aq)        (s0)
    !    SO2(ag)   = HSO3- + H+     (s1)
    !    HSO3-     = SO3-- + H+     (s2)
    !
    ! Reaction constant for Aqueous chemistry -- No big difference
    ! between Jacob and Jacobson, choose one of them.
    !
    ! Reaction rate dependent on Temperature is given
    !   H = A exp ( B (T./T - 1) )
    !
    ! For equilibrium reactions of SO2:
    !            As1      Bs1   As2      Bs2
    !  Seinfeld  1.30d-2  7.02  6.60d-8  3.76   [1998]
    !  Jacob     1.30d-2  6.75  6.31d-8  5.05   [1986]
    !  Jacobson  1.71d-2  7.04  5.99d-8  3.74   [1996]
    !=================================================================
    Ks1    = 1.30e-2_fp * EXP( 6.75e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp ) )
    Ks2    = 6.31e-8_fp * EXP( 5.05e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp ) )

    ! SIV Fraction
    XSO2aq = 1.e+0_fp/(1.e+0_fp + Ks1/Hplus + Ks1*Ks2/(Hplus*Hplus))
    XHSO3  = 1.e+0_fp/(1.e+0_fp + Hplus/Ks1 + Ks2/Hplus)
    XSO3   = 1.e+0_fp/(1.e+0_fp + Hplus/Ks2 + Hplus*Hplus/(Ks1*Ks2))

    ! Henry's constant [mol/l-atm] and Effective Henry's constant for SO2
    HCSO2  = 1.22e+0_fp * EXP( 10.55e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp) )
    FHCSO2 = HCSO2 * (1.e+0_fp + (Ks1/Hplus) + (Ks1*Ks2 / (Hplus*Hplus)))

    XSO2g  = 1.e+0_fp / ( 1.e+0_fp + ( FHCSO2 * R * T * LWC ) )
    SIV    = FHCSO2 * XSO2g * SO2 * P
    !HSO3   = Ks1 * HCSO2 * XSO2g * SO2 * P

    ! Effective HSO3aq for HOBr+HSO3
    HSO3aq = SIV * XHSO3           ! unit: M (qjc, 06/10/16)

    ! Effective SO3aq for HOBr+SO3
    SO3aq  = SIV * XSO3            ! unit: M (qjc, 06/10/16)

    !=================================================================
    ! H2O2 equilibrium reaction
    ! H2O2 + H2O = H2O2.H2O
    ! H2O2.H2O   = HO2- + H+   1)
    !
    ! Reaction rate dependent on Temperature is given
    !   H = A exp ( B (T./T - 1) )
    !
    ! For equilibrium reactions of SO2
    !            Ah1       Bh1
    !  Jacob     1.58E-12  -12.49  [1986]
    !  Jacobson  2.20E-12  -12.52  [1996]
    !=================================================================
    Kh1 = 2.20e-12_fp * EXP( -12.52e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp ) )

    ! Henry's constant [mol/l-atm] and Effective Henry's constant for H2O2
    ! [Seinfeld and Pandis, 1998]
    ! HCH2O2  = 7.45D4 * EXP( 24.48e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp) )

    ! [Jacobson,1999]
    HCH2O2  = 7.45e+4_fp * EXP( 22.21e+0_fp * (298.15e+0_fp / T - 1.e+0_fp) )
    FHCH2O2 = HCH2O2 * (1.e+0_fp + (Kh1 / Hplus))

    XH2O2g  = 1.e+0_fp / ( 1.e+0_fp + ( FHCH2O2 * R * T * LWC ) )
    !H2O2aq  = FHCH2O2 * XH2O2g * H2O2 * P

    ! Conversion rate from SO2 to SO4 via reaction with H2O2
    KaqH2O2  = kh2o2 * Ks1 * FHCH2O2 * HCSO2 * XH2O2g * XSO2g &
               * P * LWC * R * T            ! [v/v/s]

    !=================================================================
    !  Aqueous reactions of SO2 with O3
    !  SO2(aq) + O3 =>                       (0)
    !  HSO3-   + O3 => SO4-- + H+ + O2       (1)
    !  SO3--   + O3 => SO4-- + O2            (2)
    !
    ! NOTE
    ! [Jacob, 1986]
    !    KO1  = 3.49E12 * EXP( -4.83E3 / T )
    !    KO2  = 7.32E14 * EXP( -4.03E3 / T )
    !
    ! [Jacobson, 1999]
    !    KO0  = 2.40E+4
    !    KO1  = 3.70E+5 * EXP( -18.56 * ((298.15/T) - 1.))
    !    KO2  = 1.50E+9 * EXP( -17.72 * ((298.15/T) - 1.))
    !
    ! Rate constants from Jacobson is larger than those of Jacob
    ! and results in faster conversion from S(IV) to S(VI)
    ! We choose Jacob 1) 2) and Jacobson 0) here
    !=================================================================
    KO0 = 2.40e+4_fp
    KO1 = 3.49e+12_fp * EXP( -4.83e+3_fp / T )
    KO2 = 7.32e+14_fp * EXP( -4.03e+3_fp / T )

    !=================================================================
    ! H2O2 equilibrium reaction
    ! O3 + H2O = O3.H2O
    !  HCO3  = 1.13E-2 * EXP( 8.51 * (298.15/T -1.) ), S & P
    !  HCO3  = 1.13E-2 * EXP( 7.72 * (298.15/T -1.) ), Jacobson
    !=================================================================

    ! Calculate Henry's Law constant for atmospheric temperature
    HCO3  = 1.13e-2_fp * EXP( 8.51e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp ) )

    XO3g  = 1.e+0_fp / ( 1.e+0_fp + ( HCO3 * R * T * LWC ) )
    !O3aq  = HCO3 * XO3g * O3 * P

    ! Conversion rate from SO2 to SO4 via reaction with O3
    KaqO3 = (KO0*XSO2AQ + KO1*XHSO3 + KO2*XSO3) * FHCSO2 * XSO2g &
            * P * HCO3 * XO3g * LWC * R * T   ! [v/v/s]

    !(qjc, 04/10/16)
    KaqO3_1 = KO2*XSO3 * FHCSO2 * XSO2g &
              * P * HCO3 * XO3g * LWC * R * T   ! [v/v/s]

    ! ===================================================================
    ! Metal (Fe, Mn) catalyzed O2 oxidation (bec, 7/12/04)
    ! R = d[S(VI)]/dt = 750*[Mn(II)]*[S(IV)] + 2600*[Fe(III)]*[S(IV)] +
    !               1.d10*[Mn(II)]*[Fe(III)]*[S(IV)]
    ! from Seinfeld and Pandis, 1998 pg. 371
    ! S(IV) = HFCSO2 * XSO2*P*[SO2]
    ! R = KaqO2*[SO2] (v/v/s)
    ! KaqO2 = FHCSO2 * XSO2g * P *
    !        ((750*[Mn(II)])+(2600[Fe(III)])+(1.d10*[Mn(II)]*[Fe(III)]))
    ! in units of [M/s]
    ! KaqO2 = FHCSO2 * XSO2g * P *
    !        ((750*[Mn(II)])+(2600[Fe(III)])+(1.d10*[Mn(II)]*[Fe(III)])) *
    !        LWC * R * T/P
    ! in units of [v/v/s]
    ! ===================================================================

    ! Conversion rate from SO2 to SO4 via reaction with O2 (met cat)
    KaqO2 = FHCSO2 * XSO2g * ( (750e+0_fp * MnII ) + &
            ( 2600e+0_fp * FeIII ) + (1e+10_fp * MnII * FeIII ) ) * &
            LWC * R * T   ! [s-1]

    !=================================================================
    !  Aqueous reactions of SO2 with HCHO 
    !     HSO3-   + HCHO(aq) => HMS + OH-           (1)
    !     SO3--   + HCHO(aq) => HMS                 (2)
    !
    !     NOTE:
    !     [Boyce and Hoffman, 1984]
    !        KHCHO1  = 7.9E2 * EXP( -16.435 * ((298.15/T) - 1.))
    !        KHCHO2  = 2.5E7 * EXP( -6.037 * ((298.15/T) - 1.))
    !
    !  
    !  Aqueous reaction of HMS with OH-
    !    HMS + OH- => HCHO(aq) + SO3--             (3)
    !
    !     NOTE: unclear where B (E/R) value in Seinfeld and Pandis from, 
    !     but close to Deister. Using Seinfeld and Pandis value for now
    !     [Deister et al., 1986]
    !        KHMS    = 3.6E3 * EXP( -22.027 * ((298.15/T) - 1.))
    !     [Seinfeld and Pandis, 2016; Munger et al., 1986]
    !        KHMS    = 3.6E3 * EXP( -15.09 * ((298.15/T) - 1.))
    !
    !
    !  Aqueous reaction of HMS with OH(aq)
    !    HMS + OH(aq) =(SO2,O2,HO2)=> 2SO4-- + HCHO + O2 + 3H+ + 2H2O  (4)
    !  
    !    NOTE: O2, SO2, and HO2 particpate in the stoichiometry but not kinetics.
    !          Assume steady state for sulfur radicals and the following reaction chain:
    !            HMS + OH(aq) =(O2)=> SO5- + HCHO + H2O [Olsen and Fessenden, 1992]
    !            HO2 <=> H+ + O2-                       [Jacob, 1986]
    !            SO5- + O2- =(H2O)=> HSO5- + OH- + O2   [Jacob, 1986]
    !            SO2(aq) <=> HSO3- + H+
    !            H+ + OH- <=> H2O
    !            HSO5- + HSO3- => 2SO4-- + 2H+          [Jacob, 1986]
    !       Instead of assuming Henry's law for OH, use the parameter from 
    !       Jacob et al, 2005 that relates gas phase OH to aqueous phase OH
    !       accounting for the HO2(aq)/O2- cylcing in cloud droplets:
    !        dOH = 1E-19 [M cm^3 molec^-1]
    !     [Olson and Fessenden, 1992]
    !        KHMS2    = 6.2E8 * EXP( -5.03 * ((298.15/T) -1.)) 
    !   
    !
    ! (jmm, 06/28/18)
    !=================================================================
    KHCHO1 = 7.9e+2_fp * EXP( -16.44e+0_fp &
         * ( 298.15e+0_fp / T - 1.e+0_fp ) )
    KHCHO2 = 2.5e+7_fp * EXP( -6.04e+0_fp &
         * ( 298.15e+0_fp / T - 1.e+0_fp ) )
    KHMS = 3.6e+3_fp * EXP( -15.09e+0_fp &
         * ( 298.15e+0_fp / T - 1.e+0_fp ) )
    KHMS2 = 6.2e+8_fp * EXP( -5.03e+0_fp &
         * ( 298.15e+0_fp / T - 1.e+0_fp ) )

    !=================================================================
    ! HCHO equilibrium reaction
    ! HCHO(aq) + H2O   = HCH(OH)2 
    !
    ! Reaction rate dependent on Temperature is given
    !   H = A exp ( B (T./T - 1) )
    !
    ! For equilibrium reactions of HCHO
    !                             Ah1       Bh1
    !  Sienfeld and Pandis      2.53E3    13.48  [2016]
    !
    ! (jmm, 06/15/18)
    !=================================================================
    Khc1 = 2.53e+3_fp * EXP( 13.48e+0_fp &
         * ( 298.15e+0_fp / T - 1.e+0_fp ) )

    !=================================================================
    ! H2O equilibrium reaction
    !  H2O   = H+ + OH-
    !
    ! Reaction rate dependent on Temperature is given
    !   H = A exp ( B (T./T - 1) )
    !
    ! For equilibrium reactions of HCHO
    !                             Ah1       Bh1
    !  Sienfeld and Pandis       1E-14     -22.51  [2016]
    !
    ! (jmm, 06/15/18)
    !=================================================================
    Kw1 = 1e-14_fp * EXP( -22.51e+0_fp &
         *  ( 298.15e+0_fp / T - 1.e+0_fp ) )

    ! Henry's constant [mol/l-atm] and Effective Henry's constant for HCHO
    ! [Seinfeld and Pandis, 2016]
    ! HCHCHO  = 2.5 * EXP( 21.6e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp) )
    ! (jmm, -6/15/18)
    HCHCHO  = 2.5e+0_fp * EXP( 21.6e+0_fp &
         *  (298.15e+0_fp / T - 1.e+0_fp) )
    FHCHCHO = HCHCHO * (1.e+0_fp + Khc1 )

    XHCHOg  = 1.e+0_fp / ( 1.e+0_fp + ( FHCHCHO * R * T * LWC ) )


    ! Conversion rate from SO2 to HMS via reaction with HCHO
    ! (jmm, 06/15/18)
    KaqHCHO = (KHCHO1*XHSO3 + KHCHO2*XSO3) * FHCSO2 * XSO2G &
         * P * HCHCHO * XHCHOg * LWC * R * T    ! [v/v/s]

    ! Conversion rate from HMS to SO2 via reaction with OH-
    ! (jmm, 06/15/18)
    KaqHMS = KHMS * ( Kw1 / Hplus )            ! [mol/L/s]

    ! Conversion rate from HMS to SO42- & HCHO via reaction with OH(aq)
    ! (jmm, 06/28/18)
    KaqHMS2 = KHMS2 * dOH / AIRMW / AIRMW * 7.e-4_fp * AVO &
         * T * R / P                           ! [m^6 kg^-2 s^-1]

  END SUBROUTINE AQCHEM_SO2
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: init_sulfate
!
! !DESCRIPTION: Subroutine INIT\_SULFATE initializes and zeros all allocatable
!  arrays declared in "sulfate\_mod.F90" (bmy, 6/2/00, 10/15/09)
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE INIT_SULFATE( RC )
!
! !USES:
!
    USE ErrCode_Mod
    USE State_Chm_Mod,  ONLY : Ind_
!
! !INPUT/OUTPUT PARAMETERS:
!
    INTEGER,        INTENT(OUT) :: RC          ! Success or failure?
!
! !REVISION HISTORY:
!  02 Jun 2000 - R. Yantosca - Initial version
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !LOCAL VARIABLES:
!
    ! Scalars
    INTEGER            :: I, J, N

    ! Strings
    CHARACTER(LEN=255) :: ErrMsg, ThisLoc

    !=================================================================
    ! INIT_SULFATE begins here!
    !=================================================================

    ! Initialize
    RC       = GC_SUCCESS
    ErrMsg   = ''
    ThisLoc  = ' -> at Init_Sulfate (in module GeosCore/sulfate_mod.F90)'

    ! Define flags for species ID's
    id_AS    = Ind_('AS'       )
    id_AHS   = Ind_('AHS'      )
    id_AW1   = Ind_('AW1'      )
    id_DAL1  = Ind_('DSTAL1'   )
    id_DAL2  = Ind_('DSTAL2'   )
    id_DAL3  = Ind_('DSTAL3'   )
    id_DAL4  = Ind_('DSTAL4'   )
    id_DMS   = Ind_('DMS'      )
    id_DST1  = Ind_('DST1'     )
    id_DST2  = Ind_('DST2'     )
    id_DST3  = Ind_('DST3'     )
    id_DST4  = Ind_('DST4'     )
    id_H2O2  = Ind_('H2O2'     )
    id_HNO3  = Ind_('HNO3'     )
    id_HOBr  = Ind_('HOBr'     )
    id_HOCl  = Ind_('HOCl'     )
    id_LET   = Ind_('LET'      )
    id_MSA   = Ind_('MSA'      )
    id_NH3   = Ind_('NH3'      )
    id_NH4   = Ind_('NH4'      )
    id_NH4aq = Ind_('NH4aq'    )
    id_NIT   = Ind_('NIT'      )
    id_NITd1 = Ind_('NITD1'    )
    id_NITd2 = Ind_('NITD2'    )
    id_NITd3 = Ind_('NITD3'    )
    id_NITd4 = Ind_('NITD4'    )
    id_NITs  = Ind_('NITs'     )
    id_NK1   = Ind_('NK1'      )
    id_NK5   = Ind_('NK5'      )
    id_NK8   = Ind_('NK8'      )
    id_NK10  = Ind_('NK10'     )
    id_NK20  = Ind_('NK20'     )
    id_NO3   = Ind_('NO3'      )
    id_O3    = Ind_('O3'       )
    id_OH    = Ind_('OH'       )
    id_pFe   = Ind_('pFe'      )
    id_SALA  = Ind_('SALA'     )
    id_SALC  = Ind_('SALC'     )
    id_SF1   = Ind_('SF1'      )
    id_SO2   = Ind_('SO2'      )
    id_SO4   = Ind_('SO4'      )
    id_SO4aq = Ind_('SO4aq'    )
    id_SO4d1 = Ind_('SO4D1'    )
    id_SO4d2 = Ind_('SO4D2'    )
    id_SO4d3 = Ind_('SO4D3'    )
    id_SO4d4 = Ind_('SO4D4'    )
    id_SO4s  = Ind_('SO4s'     )
    id_SALACL= Ind_('SALACL'   )
    id_HCL   = Ind_('HCL'     )
    !id_NH4s  = Ind_('NH4s'     )
    id_SALCCL= Ind_('SALCCL'   )
    id_SALAAL= Ind_('SALAAL'   )
    id_SALCAL= Ind_('SALCAL'   )
    id_HCOOH = Ind_('HCOOH'    ) ! (jmm, 12/3/18)
    id_ACTA  = Ind_('ACTA'     ) ! (jmm, 12/3/18)
    id_CH2O  = Ind_('CH2O'     ) ! msl
    id_HMS   = Ind_('HMS'      ) ! msl

  END SUBROUTINE INIT_SULFATE
!EOC
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: het_drop_chem
!
! !DESCRIPTION: Subroutine HET\_DROP\_CHEM estimates the in-cloud sulfate
!  production rate in heterogeneous cloud droplets based on the Yuen et al.,
!  1996 parameterization. (bec, 6/16/11)
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE HET_DROP_CHEM( I,    J,    L,      LSTOT, SSCvv, &
                            aSO4, GNH3, SO2_sr, H2O20, GNO3,  &
                            SR,   Input_Opt,    State_Met, State_Chm )
!
! !USES:
!
    USE Input_Opt_Mod,      ONLY : OptInput
    USE State_Chm_Mod,      ONLY : ChmState
    USE State_Met_Mod,      ONLY : MetState
    USE TIME_MOD,           ONLY : GET_TS_CHEM
!
! !INPUT PARAMETERS:
!
    INTEGER,        INTENT(IN)  :: I, J, L
    REAL(fp),       INTENT(IN)  :: LSTOT
    REAL(fp),       INTENT(IN)  :: SSCvv
    REAL(fp),       INTENT(IN)  :: aSO4
    REAL(fp),       INTENT(IN)  :: GNH3
    REAL(fp),       INTENT(IN)  :: SO2_sr
    REAL(fp),       INTENT(IN)  :: H2O20
    REAL(fp),       INTENT(IN)  :: GNO3
    TYPE(OptInput), INTENT(IN)  :: Input_Opt   ! Input Options object
    TYPE(MetState), INTENT(IN)  :: State_Met   ! Meteorology State object
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(ChmState), INTENT(INOUT) :: State_Chm ! Chemistry State object
!
! !OUTPUT PARAMETERS:
!
    REAL(fp),       INTENT(OUT) :: SR          ! Sulfate production rate
!
! !REVISION HISTORY:
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    REAL(fp), PARAMETER   :: SS_DEN = 2200.e+0_fp !dry sea-salt density [kg/m3]

    ! sigma of the size distribution for sea-salt (Jaegle et al., 2011)
    REAL(fp), PARAMETER   :: SIG_S = 1.8e+0_fp

    ! geometric dry mean diameters [m] for computing lognormal size distribution
    REAL(fp), PARAMETER   :: RG_S = 0.4e-6_fp !(Jaegle et a., 2011)
    REAL(fp), PARAMETER   :: RG_D2 = 1.5e-6_fp!(Ginoux et al., 2001)
    REAL(fp), PARAMETER   :: RG_D3 = 2.5e-6_fp
    REAL(fp), PARAMETER   :: RG_D4 = 4.e-6_fp
!
! !LOCAL VARIABLES:
!
    REAL(fp)              :: alpha_NH3, alpha_SO2, alpha_H2O2
    REAL(fp)              :: alpha_HNO3, alpha_B, alpha_CN
    REAL(fp)              :: alpha_W, alpha_SO4, sum_gas, H
    REAL(fp)              :: NDss, NDd2, NDd3, NDd4, CN, DEN, REFF, W
    REAL(fp)              :: DTCHEM, APV, DSVI
    REAL(fp)              :: B, NH3, SO2, H2O2, HNO3, SO4
    REAL(fp)              :: CNss, CNd2, CNd3, CNd4
    REAL(fp)              :: MW_SO4, MW_SALC

    ! Pointers
    REAL(fp), POINTER     :: AD(:,:,:)
    REAL(fp), POINTER     :: AIRDEN(:,:,:)
    REAL(fp), POINTER     :: AIRVOL(:,:,:)
    REAL(fp), POINTER     :: OMEGA(:,:,:)
    REAL(fp), POINTER     :: U(:,:,:)
    REAL(fp), POINTER     :: V(:,:,:)

    !=================================================================
    ! HET_DROP_CHEM begins here!
    !=================================================================

    ! Initialize pointers
    AD     => State_Met%AD
    AIRDEN => State_Met%AIRDEN
    AIRVOL => State_Met%AIRVOL
    OMEGA  => State_Met%OMEGA
    U      => State_Met%U
    V      => State_Met%V

    ! Convert gas phase concentrations from [v/v] to [pptv]
    NH3  = GNH3  * 1.0e+12_fp
    SO2  = SO2_sr  * 1.0e+12_fp
    H2O2 = H2O20 * 1.0e12_fp
    HNO3 = GNO3 * 1.0e12_fp

    ! Set molecular weight local variables
    MW_SO4 = State_Chm%SpcData(id_SO4)%Info%MW_g
    MW_SALC = State_Chm%SpcData(id_SALC)%Info%MW_g

    ! Convert sulfate aerosol concentrations from [v/v] to [ug/m3]
    SO4 = ( aSO4 * AD(I,J,L) * 1.0e+9_fp ) / &
          ( ( AIRMW / MW_SO4 ) * AIRVOL(I,J,L) )

    ! Convert in cloud sulfate production rate from [v/v/timestep] to
    ! [ug/m3/timestep]
    B  = ( LSTOT * AD(I,J,L) * 1.0e+9_fp ) / &
         ( ( AIRMW / MW_SO4 ) * AIRVOL(I,J,L) )

    ! Convert coarse-mode aerosol concentrations from [v/v] to [#/cm3]
    ! based on equation in Hofmann, Science, 1990.
    ! First convert from [v/v] to [kg/m3 air]
    CNss = SSCvv * AD(I,J,L) / ( ( AIRMW / MW_SALC ) * AIRVOL(I,J,L) )

    ! Now convert from [kg/m3 air] to [#/cm3 air]
    ! Sea-salt
    NDss = ( (3.e+0_fp/4.e+0_fp) * CNss ) / (PI * SS_DEN * RG_S**3.e+0_fp * &
           exp( (9.e+0_fp/2.e+0_fp) * (LOG(SIG_S)) ** 2.e+0_fp ) ) * 1.e-6_fp

    ! Total coarse mode number concentration [#/cm3]
    CN = NDss ! sea-salt

    ! Determine regression coefficients based on the local SO2 concentration
    IF ( SO2 <= 200.0e+0_fp ) THEN
       alpha_B    = 0.5318e+0_fp
       alpha_NH3  = -1.67e-7_fp
       alpha_SO2  = 2.59e-6_fp
       alpha_H2O2 = -1.77e-7_fp
       alpha_HNO3 = -1.72e-7_fp
       alpha_W    = 1.22e-6_fp
       alpha_CN   = 4.58e-6_fp
       alpha_SO4  = -1.00e-5_fp
    ELSE IF ( SO2 > 200.0e+0_fp .AND. SO2 <= 500.0e+0_fp ) THEN
       alpha_B    = 0.5591e+0_fp
       alpha_NH3  = 3.62e-6_fp
       alpha_SO2  = 1.66e-6_fp
       alpha_H2O2 = 1.06e-7_fp
       alpha_HNO3 = -5.45e-7_fp
       alpha_W    = -5.79e-7_fp
       alpha_CN   = 1.63e-5_fp
       alpha_SO4  = -7.40e-6_fp
    ELSE IF ( SO2 > 500.0e+0_fp .AND. SO2 < 1000.0e+0_fp ) THEN
       alpha_B    = 1.1547e+0_fp
       alpha_NH3  = -4.28e-8_fp
       alpha_SO2  = -1.23e-7_fp
       alpha_H2O2 = -9.05e-7_fp
       alpha_HNO3 = 1.73e-7_fp
       alpha_W    = 7.22e-6_fp
       alpha_CN   = 2.44e-5_fp
       alpha_SO4  = 3.25e-5_fp
    ELSE IF ( SO2 >= 1000.0e+0_fp ) THEN
       alpha_B    = 1.1795e+0_fp
       alpha_NH3  = 2.57e-7_fp
       alpha_SO2  = -5.54e-7_fp
       alpha_H2O2 = -1.08e-6_fp
       alpha_HNO3 = 1.95e-6_fp
       alpha_W    = 6.14e-6_fp
       alpha_CN   = 1.64e-5_fp
       alpha_SO4  = 2.48e-6_fp
    ENDIF

    ! Updraft velocity over the oceans [cm/s]
    ! 500 cm/s is too high. Get W from the met field. (qjc, 04/10/16)
    !W = 500e+0_fp
    W = -OMEGA(I,J,L) / ( AIRDEN(I,J,L) * g0 ) * 100e+0_fp

    ! Compute H (integration time interval * air parcel velocity) [m]
    ! DTCHEM is the chemistry timestep in seconds
    DTCHEM = GET_TS_CHEM()

    ! Compute air parcel velocity [m/s]
    !APV = SQRT( (U(I,J,L) * U(I,J,L)) + (V(I,J,L) * V(I,J,L)) )
    !(qjc, 04/10/16)
    APV = SQRT( (U(I,J,L) * U(I,J,L)) + (V(I,J,L) * V(I,J,L)) + &
                 W * W *1.e-4_fp )

    H   = DTCHEM * APV          ![m]

    sum_gas = (alpha_NH3 * NH3) + (alpha_SO2 * SO2) + &
              (alpha_H2O2 * H2O2) + (alpha_HNO3 * HNO3)

    DSVI = ( alpha_B * B ) + &
           ( ( (alpha_CN * CN) + (alpha_W * W) + (alpha_SO4 * SO4) + &
                sum_gas ) * H )

    ! Only calculate SR when air parcel rises, in consistence with
    ! Yuen et al. (1996) (qjc, 04/10/16)
    IF ( W > 0e+0_fp ) THEN

       ! additional sulfate production that can be attributed to
       ! ozone [ug/m3/timestep]
       SR = DSVI - B

       ! Convert SR from [ug/m3/timestep] to [v/v/timestep]
       SR = SR * ( AIRMW / MW_SO4 ) * 1.e-9_fp / AIRDEN(I,J,L)

       ! Don't allow SR to be negative
       SR = MAX( SR, 0.e+0_fp )

       ! Don't produce more SO4 than SO2 available after AQCHEM_SO2
!       SR = MIN( SR, SO2_sr )

    ELSE
       SR = 0.e+0_fp
    ENDIF

    ! Free pointers
    AD     => NULL()
    AIRDEN => NULL()
    AIRVOL => NULL()
    OMEGA  => NULL()
    U      => NULL()
    V      => NULL()

  END SUBROUTINE HET_DROP_CHEM
!EOC

  SUBROUTINE SET_2R_CLD( T, LWC, FC, HPLUS, CVFAC, P, SO2, H2O2, KaqH2O2 )

    REAL(fp), PARAMETER   :: R = 0.08205e+0_fp
    REAL(FP) :: KH2O2, KS1, KS2, T, XSO2aq, LWC, FC
    REAL(FP) :: XHSO3, XSO3, HCSO2, HPLUS, FHCSO2
    REAL(FP) :: XSO2g, KH1, HCH2O2, FHCH2O2, XH2O2g
    REAL(FP) :: KaqH2O2
    REAL(FP) :: SO2, H2O2, A, B, KAB, CVFAC, P

    ! [Jacob, 1986]
    KH2O2 = 6.31e+14_fp * EXP( -4.76e+3_fp / T )
    Ks1    = 1.30e-2_fp * EXP( 6.75e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp ) )
    Ks2    = 6.31e-8_fp * EXP( 5.05e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp ) )

    ! SIV Fraction
    XSO2aq = 1.e+0_fp/(1.e+0_fp + Ks1/Hplus + Ks1*Ks2/(Hplus*Hplus))
    XHSO3  = 1.e+0_fp/(1.e+0_fp + Hplus/Ks1 + Ks2/Hplus)
    XSO3   = 1.e+0_fp/(1.e+0_fp + Hplus/Ks2 + Hplus*Hplus/(Ks1*Ks2))

    ! Henry's constant [mol/l-atm] and Effective Henry's constant for SO2
    HCSO2  = 1.22e+0_fp * EXP( 10.55e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp) )
    FHCSO2 = HCSO2 * (1.e+0_fp + (Ks1/Hplus) + (Ks1*Ks2 / (Hplus*Hplus)))

    XSO2g  = 1.e+0_fp / ( 1.e+0_fp + ( FHCSO2 * R * T * LWC ) )
    Kh1 = 2.20e-12_fp * EXP( -12.52e+0_fp * ( 298.15e+0_fp / T - 1.e+0_fp ) )

    ! [Jacobson,1999]
    HCH2O2  = 7.45e+4_fp * EXP( 22.21e+0_fp * (298.15e+0_fp / T - 1.e+0_fp) )
    FHCH2O2 = HCH2O2 * (1.e+0_fp + (Kh1 / Hplus))

    XH2O2g  = 1.e+0_fp / ( 1.e+0_fp + ( FHCH2O2 * R * T * LWC ) )
       
!    KaqH2O2  = kh2o2 * Ks1 * FHCH2O2 * HCSO2 * XH2O2g * XSO2g &

    A = SO2
    B = H2O2

    KAB = kh2o2 * Ks1 * FHCH2O2 * HCSO2 * XH2O2g * XSO2g &
               * P * LWC * R * T * CVFAC ! cm2/mcl/s

  END SUBROUTINE SET_2R_CLD

  FUNCTION CloudHet2R( A, B, FC, KAB )  RESULT( KX )
!
! !INPUT PARAMETERS:
!
      REAL(fp),         INTENT(IN) :: FC         ! Cloud Fraction [0-1]
      REAL(fp),         INTENT(IN) :: A, B       ! Reactant Abundances
      REAL(fp),         INTENT(IN) :: KAB        ! Bimolecular Rate Constant
!
! !RETURN VALUE:
!
      REAL(fp)                     :: KX ! Grid-average loss frequency, cm3/mcl/s
!
! !REVISION HISTORY:
!  23 Aug 2018 - C. D. Holmes - Initial version
!  15 May 2021 - M. Long      - Revision for two reactants
!  See https://github.com/geoschem/geos-chem for complete history
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! Residence time of air in clouds, s
      REAL(FP), PARAMETER :: TAUC = 3600
!
! !LOCAL VARIABLES:
!
      REAL(FP) :: KAO, KBO
      REAL(FP) :: FF
!
!------------------------------------------------------------------------------
!
      
      ! Ratio of volume inside to outside cloud
      ! FF has a range [0,+inf], so cap it at 1e30
      FF = SAFE_DIV( FC, (1e0_fp - FC), 1e30_fp )
      FF = MAX( FF, 1e30_fp )

      KAO = 1e0_fp/((TAUC/FF)+(1e0_fp/(FC*KAB*B))) ! 1/s
      KBO = 1e0_fp/((TAUC/FF)+(1e0_fp/(FC*KAB*A))) ! 1/s

      IF ( KAO*A .LE. KBO*B ) THEN
         KX = KAO/B
      ELSE
         KX = KBO/A
      ENDIF

  END FUNCTION CloudHet2R
!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: CloudHet
!
! !DESCRIPTION: Function CloudHet calculates the loss frequency (1/s) of gas
!  species due to heterogeneous chemistry on clouds in a partially cloudy grid
!  cell. The function uses the "entrainment limited uptake" equations of
!  Holmes et al. (2019). Both liquid and ice water clouds are treated.
!
!  For gasses that are that are consumed in multiple aqueous reactions with different
!  products, CloudHet can provide the loss frequency for each reaction branch using the
!  optional branch ratios (branchLiq, branchIce) as arguments.
!
!  Holmes, C.D., Bertram, T. H., Confer, K. L., Ronan, A. C., Wirks, C. K., Graham, K. A.,
!    Shah, V. (2019) The role of clouds in the tropospheric NOx cycle: a new modeling
!    approach for cloud chemistry and its global implications, Geophys. Res. Lett. 46,
!    4980-4990, https://doi.org/10.1029/2019GL081990
!\\
!\\
! !INTERFACE:
!
    FUNCTION CloudHet1R( fc, rate) &
                       RESULT( kHet )
!
! !INPUT PARAMETERS:
!
      REAL(fp),         INTENT(IN) :: fc         ! Cloud Fraction [0-1]
      REAL(fp),         INTENT(IN) :: rate       ! 1st order reaction rate (1/s)
!
! !RETURN VALUE:
!
      REAL(fp)                     :: kHet ! Grid-average loss frequency, 1/s
!
! !REVISION HISTORY:
!  23 Aug 2018 - C. D. Holmes - Initial version
!  25 May 2021 - M. S. Long - Modified for 1st order aqueous reaction where diffusion is not limiting
!  See https://github.com/geoschem/geos-chem for complete history
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
      ! Residence time of air in clouds, s
      real(fp), parameter :: tauc = 3600
!
! !LOCAL VARIABLES:
!
      real(fp) :: kI, gam
      real(fp) :: kk, ff, xx
!
!------------------------------------------------------------------------------
!
      ! If cloud fraction < 0.0001 (0.01%) or there is zero cloud surface area,
      ! then return zero uptake
      if ( (fc < 0.0001) .or. (rate <= 0) ) then
         kHet = 0.0_fp
         return
      endif

      !------------------------------------------------------------------------
      ! Loss frequency inside cloud
      !
      ! Assume both water and ice phases are inside the same cloud, so mass
      ! transport to both phases works in parallel (additive)
      !------------------------------------------------------------------------

      ! initialize loss, 1/s
      kI  = rate ! total loss rate of a gas in cloud

      !------------------------------------------------------------------------
      ! Grid-average loss frequency
      !
      ! EXACT expression for entrainment-limited uptake
      !------------------------------------------------------------------------

      ! Ratio (in cloud) of heterogeneous loss to detrainment, s/s
      kk = kI * tauc

      ! Ratio of volume inside to outside cloud
      ! ff has a range [0,+inf], so cap it at 1e30
      ff = safe_div( fc, (1e0_fp - fc), 1e30_fp )
      ff = max( ff, 1e30_fp )

      ! Ratio of mass inside to outside cloud
      ! xx has range [0,+inf], but ff is capped at 1e30, so this shouldn't overflow
      xx =     ( ff - kk - 1e0_fp ) / 2e0_fp + &
           sqrt( 1e0_fp + ff**2 + kk**2 + 2*ff**2 + 2*kk**2 - 2*ff*kk ) / 2e0_fp

      ! Overall heterogeneous loss rate, grid average, 1/s
      ! kHet = kI * xx / ( 1d0 + xx )
      !  Since the expression ( xx / (1+xx) ) may behave badly when xx>>1,
      !  use the equivalent 1 / (1 + 1/x) with an upper bound on 1/x
      kHet = kI / ( 1e0_fp + safe_div( 1e0_fp, xx, 1e30_fp ) )

    end function CloudHet1R
!EOC

!------------------------------------------------------------------------------
!                  GEOS-Chem Global Chemical Transport Model                  !
!------------------------------------------------------------------------------
!BOP
!
! !IROUTINE: get_dust_alk
!
! !DESCRIPTION: Subroutine GET\_DUST\_ALK returns: (1) dust alkalinity,
!  ALK\_d(NDSTBIN) [v/v], (2) rate coefficients, KTS(NDSTBIN), KTN(NDSTBIN),
!  for uptake of SO2 and HNO3 on dust for use in sulfate\_mod.f for chemistry
!  on dust aerosols, (3) fraction, KTH(NDSTBIN), of the size-weighted total
!  area of aerosols in the grid box. GET\_DUST\_ALK is analogous to GET\_ALK
!  for seasalt (bec, 12/7/04; tdf 04/08/08)
!\\
!\\
! !INTERFACE:
!
  SUBROUTINE GET_DUST_ALK( I, J, L, ALK_d, KTS, KTN, KTH, &
                           Input_Opt, State_Met, State_Chm )
!
! !USES:
!
    USE CMN_SIZE_MOD,       ONLY : NDUST, NDSTBIN
    USE ERROR_MOD,          ONLY : IT_IS_NAN
    USE Input_Opt_Mod,      ONLY : OptInput
    USE PhysConstants,      ONLY : PI, AIRMW
    USE State_Chm_Mod,      ONLY : ChmState
    USE State_Met_Mod,      ONLY : MetState
!
! !INPUT PARAMETERS:
!
    INTEGER,        INTENT(IN)    :: I, J, L        ! Grid box indices
    TYPE(OptInput), INTENT(IN)    :: Input_Opt      ! Input Options object
    TYPE(MetState), INTENT(IN)    :: State_Met      ! Meteorology State object
!
! !INPUT/OUTPUT PARAMETERS:
!
    TYPE(ChmState), INTENT(INOUT) :: State_Chm      ! Chemistry State object
!
! !OUTPUT PARAMETERS:
!
    REAL(fp),       INTENT(OUT)   :: ALK_d(NDSTBIN) ! Dust alkalinity [v/v]
    REAL(fp),       INTENT(OUT)   :: KTS  (NDSTBIN) ! Rate coef for uptake of
                                                    ! SO2 on dust [s-1]
    REAL(fp),       INTENT(OUT)   :: KTN  (NDSTBIN) ! Rate coef for uptake of
                                                    ! HNO3 on dust [s-1]
    REAL(fp),       INTENT(OUT)   :: KTH  (NDSTBIN) ! Fraction of the size-
                                                    ! weighted total area
                                                    ! of aerosols in grid box
!
! !REVISION HISTORY:
!  08 Apr 2008 - T.D. Fairlie- Initial version
!  See https://github.com/geoschem/geos-chem for complete history
!EOP
!------------------------------------------------------------------------------
!BOC
!
! !DEFINED PARAMETERS:
!
    REAL(fp), PARAMETER :: MINDAT = 1.d-20

    ! Need this for dust
    !REAL(fp), PARAMETER :: GAMMA_SO2 = 0.05d0  !(Song & Carmichael, 2001)
    ! 200 times smaller 8/28/2K9
    REAL(fp), PARAMETER :: GAMMA_SO2 = 2.5d-4

    !tdf V9 4/1/2K9 Applying Song et al.(2007) reduced value
    REAL(fp), PARAMETER :: GAMMA_H2SO4 = 1.d0

    !  Need this for dust
    !REAL(fp), PARAMETER :: GAMMA_HNO3 = 0.1d0 ! (Song & Carmichael, 2001)
    ! 200 times smaller 8/28/2K9
    REAL(fp), PARAMETER :: GAMMA_HNO3 = 5.0d-4

    REAL(fp), PARAMETER :: DG = 0.2d0 ! gas phase diffusion coeff. [cm2/s]
    REAL(fp), PARAMETER :: v = 3.0d4  ! cm/s
!
! !LOCAL VARIABLES:
!
    ! Scalars
    INTEGER             :: IRH
    INTEGER             :: IBIN, ISBIN
    REAL(fp)            :: N1, KT1, KT1N
    REAL(fp)            :: AREA, HGF
    REAL(fp)            :: CONST1, CONST2, CONST
    REAL(fp)            :: AIR_DENS
    REAL(fp)            :: A1, B1, A1N, B1N, T1, R1
    REAL(fp)            :: DD, RD, DM
    REAL(fp)            :: TOTAL_AREA, DF_TOTAL_AREA
    REAL(fp)            :: DST_d (NDSTBIN), ALK, GAMS, GAMN
    REAL(fp)            :: SULF_AREA, BC_AREA, OC_AREA
    REAL(fp)            :: SULF_RAD, BC_RAD, OC_RAD
    REAL(fp)            :: SULF_FAC, BC_FAC, OC_FAC
    REAL(fp)            :: SSA_AREA, SSC_AREA
    REAL(fp)            :: SSA_RAD, SSC_RAD
    REAL(fp)            :: SSA_FAC, SSC_FAC
    LOGICAL, SAVE       :: FIRST = .TRUE.

    ! Arrays
    ! Dust Surface Areas                                ! tdf 08/20/09
    REAL(fp)            :: AREA_d(NDSTBIN)              ! [cm^2/cm^3]

    ! Dust Surface Areas within sub-bins 1-4 of BIN 1   ! tdf 08/20/09
    REAL(fp)            :: AREA_sd1(4)                  ! [cm^2/cm^3]

    ! Dust Effective Radius                             ! tdf 08/20/09
    REAL(fp)            :: RD_d(NDSTBIN)                ! [cm]

    ! Dust Effective Radii for sub-bins 1-4 of BIN 1    ! tdf 08/20/09
    REAL(fp)            :: RD_sd1(4)                    ! [cm]

    ! Dust size-weighted Surface Areas                  ! tdf 08/20/09
    REAL(fp)            :: DF_AREA_d(NDSTBIN)           ! [1/s]

    ! Dust size-weighted Surface Areas for sub-bins 1-4 ! tdf 08/20/09
    REAL(fp)            :: DF_AREA_sd1(4)               ! [1/s]

    ! Molecular weights
    REAL(fp)            :: MW_DST1, MW_DST2, MW_DST3, MW_DST4

    ! Pointers
    REAL(fp), POINTER   :: Spc(:,:,:,:)
    REAL(fp), POINTER   :: ERADIUS(:,:,:,:)
    REAL(fp), POINTER   :: TAREA(:,:,:,:)

    !=================================================================
    ! GET_DUST_ALK begins here!
    !=================================================================

    ! Initialize pointers
    Spc      => State_Chm%Species  ! GEOS-Chem species array [v/v dry]
    ERADIUS  => State_Chm%AeroRadi ! Aerosol Radius [cm]
    TAREA    => State_Chm%AeroArea ! Aerosol Area [cm2/cm3]

    ! Get MWs from species database
    MW_DST1 = State_Chm%SpcData(id_DST1)%Info%MW_g
    MW_DST2 = State_Chm%SpcData(id_DST2)%Info%MW_g
    MW_DST3 = State_Chm%SpcData(id_DST3)%Info%MW_g
    MW_DST4 = State_Chm%SpcData(id_DST4)%Info%MW_g

    ! Zero variables
    DO IBIN = 1, NDSTBIN
       ALK_d (IBIN)  = 0.0e+0_fp
       KTS   (IBIN)  = 0.0e+0_fp
       KTN   (IBIN)  = 0.0e+0_fp
       KTH   (IBIN)  = 0.0e+0_fp
       AREA_d (IBIN) = 0.0e+0_fp
       RD_d (IBIN)   = 0.0e+0_fp
    END DO

    ! Air density [kg/m3]
    AIR_DENS = State_Met%AD(I,J,L) / State_Met%AIRVOL(I,J,L)

    ! Retrieve Dust Alkalinity [v/v dry from Spc array
    ALK_d(1) = Spc(I,J,L,id_DAL1)
    ALK_d(2) = Spc(I,J,L,id_DAL2)
    ALK_d(3) = Spc(I,J,L,id_DAL3)
    ALK_d(4) = Spc(I,J,L,id_DAL4)

    ! Dust [kg/m3] from Spc, used to compute dust surface area
    ! Units: (moles/mole).(kg(air)/m3).(kg(dust)/mole)/(kg(air)/mole)
    DST_d(1) = Spc(I,J,L,id_DST1) * AIR_DENS / ( AIRMW / MW_DST1 )
    DST_d(2) = Spc(I,J,L,id_DST2) * AIR_DENS / ( AIRMW / MW_DST2 )
    DST_d(3) = Spc(I,J,L,id_DST3) * AIR_DENS / ( AIRMW / MW_DST3 )
    DST_d(4) = Spc(I,J,L,id_DST4) * AIR_DENS / ( AIRMW / MW_DST4 )

    ! tdf Now get aerosol surface area from TAREA (cm2/cm3)
    SULF_AREA = TAREA(I,J,L,NDUST+1)
    BC_AREA   = TAREA(I,J,L,NDUST+2)
    OC_AREA   = TAREA(I,J,L,NDUST+3)
    SSA_AREA  = TAREA(I,J,L,NDUST+4)
    SSC_AREA  = TAREA(I,J,L,NDUST+5)

    ! tdf Now get aerosol effective radius from ERADIUS (cm)
    SULF_RAD  = ERADIUS(I,J,L,NDUST+1)
    BC_RAD    = ERADIUS(I,J,L,NDUST+2)
    OC_RAD    = ERADIUS(I,J,L,NDUST+3)
    SSA_RAD   = ERADIUS(I,J,L,NDUST+4)
    SSC_RAD   = ERADIUS(I,J,L,NDUST+5)

    ! tdf Quotients [s/cm] used to weight surface area for H2SO4 uptake
    SULF_FAC = (SULF_RAD / DG + 4.e+0_fp/(V*GAMMA_H2SO4) )
    BC_FAC   = (  BC_RAD / DG + 4.e+0_fp/(V*GAMMA_H2SO4) )
    OC_FAC   = (  OC_RAD / DG + 4.e+0_fp/(V*GAMMA_H2SO4) )
    SSA_FAC  = ( SSA_RAD / DG + 4.e+0_fp/(V*GAMMA_H2SO4) )
    SSC_FAC  = ( SSC_RAD / DG + 4.e+0_fp/(V*GAMMA_H2SO4) )

    !tdf Surface areas and effective radii for sub-bins 1-4 of dust bin 1
    DO ISBIN = 1, 4
       T1 = TAREA  (I,J,L,ISBIN)
       R1 = ERADIUS(I,J,L,ISBIN)
       AREA_sd1    (ISBIN) = T1
       RD_sd1      (ISBIN) = R1
       !tdf surface area for sub bins 1-4 in bin 1, weighted by gas-phase
       !tdf diffusion and collision limitations
       !tdf used to compute proportionate uptake of H2SO4 only  [1/s]
       DF_AREA_sd1 (ISBIN) = T1 / (R1/DG + 4.0e+0_fp/(V*GAMMA_H2SO4))
    END DO

    !-----------------------------------------------------------------------
    ! Very Simple Formulation: For each size bin (i)   ! tdf 8/20/09
    ! Dust Area density = 3 * Dust Mass density  / (REFF(i) * DUSTDEN)
    ! TAREA computed   in RDUST_ONLINE - Units: cm^2(dust) / cm^3(air)
    ! ERADIUS computed in RDUST_ONLINE - Units: cm
    ! NB: I am now subdividing the submicron dust size bin
    !     using TAREA (I,J,L,1->4), and ERADIUS (I,J,L,1->4).
    !-----------------------------------------------------------------------

    !-------------------------------------------------------------------------
    !  Find Dust surface area density in grid-box, AREA_d [cm^2/cm^3].
    !  Also find the size-weighted surface area density, DF_AREA_d [1/s].
    !  The latter represents the gas-phase diffusion and surface
    !  limited weighting and is used to determine the fraction of H2SO4
    !  taken up on dust, versus taken up on other aerosols.
    !                                                 tdf 08/21/09
    !-------------------------------------------------------------------------

    ! tdf Loop over size bins  (NDSTBIN = 4)
    DO IBIN = 1, NDSTBIN

       ! Dust Area density in grid box,      AREA_d [cm^2/cm^3]    tdf 8/21/09
       ! Dust weighted surface area density, DF_AREA_d [1/s]       tdf 8/21/09

       IF (IBIN .EQ. 1) THEN
          ! For Dust size bin 1, sum over the 4 size sub bins  tdf 8/21/09
          AREA_d   (IBIN) = AREA_sd1(1) + AREA_sd1(2) &       ![cm^2/cm^3]
                          + AREA_sd1(3) + AREA_sd1(4)
          DF_AREA_d(IBIN) = DF_AREA_sd1(1) + DF_AREA_sd1(3) &  ! [1/s]
                          + DF_AREA_sd1(2) + DF_AREA_sd1(4)
       ELSE
          T1 = TAREA(I,J,L,3+IBIN)      ! [cm^2/cm^3]
          R1 = ERADIUS(I,J,L,3+IBIN)    ! [cm]
          RD_d     (IBIN) = R1
          AREA_d   (IBIN) = T1          ! [cm^2/cm^3]
          DF_AREA_d(IBIN) = T1 / (R1/DG + 4.0D0/(V*GAMMA_H2SO4)) ! [1/s]
       ENDIF

    END DO

    ! tdf total aerosol surface area  [cm^2/cm^3]
    TOTAL_AREA = SULF_AREA + BC_AREA + OC_AREA + SSA_AREA  + SSC_AREA + &
                 AREA_d(1) + AREA_d(2) + AREA_d(3) + AREA_d(4)

    ! tdf total surface area weighted by gas-phase diffusion limitation [1/s]
    DF_TOTAL_AREA = SULF_AREA / SULF_FAC + &
                    BC_AREA   / BC_FAC   + &
                    OC_AREA   / OC_FAC   + &
                    SSA_AREA  / SSA_FAC  + &
                    SSC_AREA  / SSC_FAC  + &
                    DF_AREA_d(1)         + &
                    DF_AREA_d(2)         + &
                    DF_AREA_d(3)         + &
                    DF_AREA_d(4)

    ! tdf Total Dust Alkalinity
    ALK = ALK_d(1) + ALK_d(2) + ALK_d(3) + ALK_d(4)  ! [v/v]

    ! set humidity index IRH as a percent
    IRH = State_Met%RH(I,J,L)
    IRH = MAX(  1, IRH )
    IRH = MIN( 99, IRH )

    ! hygroscopic growth factor for dust: Set to NO GROWTH for now
    IF ( IRH < 100 ) HGF = 1.0e+0_fp

    ! tdf Loop over size bins (NDSTBIN = 4)
    DO IBIN = 1, NDSTBIN

       !----------------------------------
       ! SO2 uptake onto particles
       !----------------------------------

       !tdf 2/11/2K9
       !tdf Following relative uptake rates of Preszler-Prince et al.(2007)
       IF (IRH >= 90 ) THEN
          GAMS = GAMMA_SO2 * 2.e+0_fp
       ELSE IF (IRH >= 84 ) THEN
          GAMS = GAMMA_SO2 * (0.5e+0_fp  + 1.5e+0_fp*(IRH-84.e+0_fp)/ &
                 (90.e+0_fp-84.e+0_fp))
       ELSE IF (IRH >= 76 ) THEN
          GAMS = GAMMA_SO2 * (0.16e+0_fp + 0.34e+0_fp*(IRH-76.e+0_fp)/ &
                 (84.e+0_fp-76.e+0_fp))
       ELSE IF (IRH >= 33 ) THEN
          GAMS = GAMMA_SO2 * (0.03e+0_fp + 0.13e+0_fp*(IRH-33.e+0_fp)/ &
                 (76.e+0_fp-33.e+0_fp))
       ELSE IF (IRH >= 20 ) THEN
          GAMS = GAMMA_SO2*0.03e+0_fp
       ELSE                        ! 0.0 below 20%
          GAMS = GAMMA_SO2*0.0e+0_fp
       ENDIF

       ! Check for sufficient alkalinity          tdf 3/28/2K8
       IF ( ALK > MINDAT ) THEN

          ! calculate gas-to-particle rate constant for uptake of
          ! SO2 onto dust aerosols [Jacob, 2000] analytical solution
          ! Corrected based on discussions with Becky     tdf 07/14/08
          KT1    = 0.0e+0_fp

          IF (IBIN .EQ. 1) THEN

             ! tdf Sum over the 1-4 sub-bins for bin 1      ! tdf 08/21/2K9
             DO ISBIN = 1, 4
                RD     = RD_sd1 (ISBIN)        ! effective radius [cm]
                AREA   = AREA_sd1 (ISBIN)      ! Dust Surface Area [cm^2/cm^3]

                ! Prevent divide by zero if GAMS = 0 (tdf, mps, 11/14/13)
                IF ( GAMS > 0.e+0_fp ) THEN
                   CONST1 = 4.e+0_fp/(V*GAMS)  ! Collision [s/cm]
                   CONST2 = RD/DG              ! Diffusion [s/cm]
                   CONST  = CONST1 + CONST2
                   KT1    = KT1 + AREA / CONST ! [cm^2/cm^3] * [cm/s] = [1/s]
                ELSE
                   KT1    = KT1                ! [cm^2/cm^3] * [cm/s] = [1/s]
                ENDIF
             END DO

          ELSE

             RD     = RD_d (IBIN)              ! effective radius [cm]
             AREA   = AREA_d (IBIN)            ! Dust Surface Area [cm^2/cm^3]

             ! Prevent divide by zero if GAMS = 0 (tdf, mps, 11/14/13)
             IF ( GAMS > 0.e+0_fp ) THEN
                CONST1 = 4.e+0_fp/(V*GAMS)     ! Collision [s/cm]
                CONST2 = RD/DG                 ! Diffusion [s/cm]
                CONST  = CONST1 + CONST2
                KT1    = AREA / CONST          ! [cm^2/cm^3] * [cm/s] = [1/s]
             ELSE
                KT1    = 0.0e+0_fp             ! [cm^2/cm^3] * [cm/s] = [1/s]
             ENDIF

          ENDIF

          KTS(IBIN) = KT1

       ELSE

          ! If no alkalinity, set rate coefficients to zero
          !tdf
          KTS(IBIN)  = 0.0e+0_fp

       ENDIF

       !----------------------------------
       ! HNO3 uptake onto particles
       !----------------------------------

       !tdf 2/11/2K9
       !tdf Following uptake coefficients of Liu et al.(2007)
       IF (IRH >= 80 ) THEN
          GAMN = GAMMA_HNO3 * 2.1e+0_fp
       ELSE IF (IRH >= 70 ) THEN
          GAMN = GAMMA_HNO3 * (1.3e+0_fp  + 0.7e+0_fp   * &
                 (IRH - 70.e+0_fp)/ 10.e+0_fp)
       ELSE IF (IRH >= 60 ) THEN
          GAMN = GAMMA_HNO3 * (1.0e+0_fp  + 0.3e+0_fp   * &
                 (IRH - 60.e+0_fp)/  10.e+0_fp)
       ELSE IF (IRH >= 50 ) THEN
          GAMN = GAMMA_HNO3 * (0.7e+0_fp  + 0.3e+0_fp   * &
                 (IRH - 50.e+0_fp)/ 10.e+0_fp)
       ELSE IF (IRH >= 30 ) THEN
          GAMN = GAMMA_HNO3 * (0.19e+0_fp + 0.255e+0_fp * &
                 (IRH - 30.e+0_fp)/ 10.e+0_fp)
       ELSE IF (IRH >= 10 ) THEN
          GAMN = GAMMA_HNO3 * (0.03e+0_fp + 0.08e+0_fp  * &
                 (IRH - 10.e+0_fp)/ 10.e+0_fp)
       ELSE
          ! 0.0 below 10%
          GAMN = GAMMA_HNO3*0.0e+0_fp
       ENDIF

       ! Check for sufficient alkalinity      tdf 3/28/2K8
       IF ( ALK > MINDAT ) THEN

          ! calculate gas-to-particle rate constant for uptake of
          ! HNO3 onto dust aerosols [Jacob, 2000] analytical solution
          ! Corrected based on discussions with Becky     tdf 07/14/08
          KT1    = 0.0e+0_fp

          IF (IBIN .EQ. 1) THEN

             ! tdf Sum over the 1-4 sub-bins for bin 1      ! tdf 08/21/2K9
             DO ISBIN = 1, 4
                RD = RD_sd1 (ISBIN)            ! effective radius [cm]
                AREA = AREA_sd1 (ISBIN)        ! Dust Surface Area [cm^2/cm^3]

                ! Prevent divide by zero if GAMN = 0 (tdf, mps, 11/14/13)
                IF ( GAMN > 0.e+0_fp ) THEN
                   CONST1 = 4.e+0_fp/(V*GAMN)  ! Collision [s/cm]
                   CONST2 = RD/DG              ! Diffusion [s/cm]
                   CONST  = CONST1 + CONST2
                   KT1    = KT1 + AREA / CONST ! [cm^2/cm^3] * [cm/s] = [1/s]
                ELSE
                   KT1    = KT1                ! [cm^2/cm^3] * [cm/s] = [1/s]
                ENDIF
             END DO

          ELSE

             RD     = RD_d (IBIN)              ! effective radius [cm]
             AREA   = AREA_d (IBIN)            ! Dust Surface Area [cm^2/cm^3]

             ! Prevent divide by zero if GAMN = 0 (tdf, mps, 11/14/13)
             IF ( GAMN > 0.e+0_fp ) THEN
                CONST1 = 4.e+0_fp/(V*GAMN)     ! Collision [s/cm]
                CONST2 = RD/DG                 ! Diffusion [s/cm]
                CONST  = CONST1 + CONST2
                KT1    = AREA / CONST          ! [cm^2/cm^3] * [cm/s] = [1/s]
             ELSE
                KT1    = 0.0e+0_fp             ! [cm^2/cm^3] * [cm/s] = [1/s]
             ENDIF

          ENDIF

          KTN(IBIN) = KT1

       ELSE

          ! If no alkalinity, set rate coefficients to zero
          !tdf
          KTN(IBIN)  = 0.0e+0_fp

       ENDIF

       !----------------------------------
       ! H2SO4 uptake onto particles
       !----------------------------------

       ! Uptake not limited by dust alkalinity      tdf 3/02/2K9

       !tdf As of 08/20/09, we use AREA and size weighted uptake
       !tdf where now KTH is a fractional uptake for each size bin
       !tdf with respect to total aerosol surface area.

       KT1    = DF_AREA_d(IBIN) / DF_TOTAL_AREA   ! Fraction

       KTH(IBIN) = KT1

    END DO ! tdf End Loop over size bins

    ! Free pointers
    Spc     => NULL()
    ERADIUS => NULL()
    TAREA   => NULL()

  END SUBROUTINE GET_DUST_ALK
!EOC
END MODULE GCKPP_SULFATE
